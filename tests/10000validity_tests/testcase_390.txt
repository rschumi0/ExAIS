import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0Sub9601 = tf.keras.layers.Input(shape=([2, 3, 3]))
in1Sub9601 = tf.keras.layers.Input(shape=([2, 3, 3]))
in0Mul86468 = tf.keras.layers.Input(shape=([2, 2, 1]))
in1Mul86468 = tf.keras.layers.Input(shape=([2, 2, 1]))

Sub9601 = keras.layers.Subtract(name = 'Sub9601', )([in0Sub9601,in1Sub9601])
Res29051 = keras.layers.Reshape((2, 9), name = 'Res29051', )(Sub9601)
Mul86468 = keras.layers.Multiply(name = 'Mul86468', )([in0Mul86468,in1Mul86468])
Res45974 = keras.layers.Reshape((2, 2, 1, 1), name = 'Res45974', )(Mul86468)
Glo36373 = keras.layers.GlobalMaxPool3D(name = 'Glo36373', )(Res45974)
Res39617 = keras.layers.Reshape((1, 1), name = 'Res39617', )(Glo36373)
Res8079 = keras.layers.Reshape((1, 1, 1), name = 'Res8079', )(Res39617)
Res60707 = keras.layers.Reshape((1, 1, 1, 1), name = 'Res60707', )(Res8079)
Con57531 = keras.layers.Conv3D(3, (1, 1, 1),strides=(1, 3, 6), padding='same', dilation_rate=(1, 1, 1), name = 'Con57531', )(Res60707)
Res49414 = keras.layers.Reshape((1, 1, 3), name = 'Res49414', )(Con57531)
Res34865 = keras.layers.Reshape((1, 3), name = 'Res34865', )(Res49414)
Zer24573 = keras.layers.ZeroPadding1D(padding=((1, 0)), name = 'Zer24573', )(Res34865)
Dot35261 = keras.layers.Dot(axes=(1, 1), name = 'Dot35261', )([Res29051,Zer24573])
Res93135 = keras.layers.Reshape((9, 3, 1), name = 'Res93135', )(Dot35261)
Con16308 = keras.layers.Conv2D(3, (2, 2),strides=(5, 1), padding='valid', dilation_rate=(1, 1), name = 'Con16308', )(Res93135)
model = tf.keras.models.Model(inputs=[in0Sub9601,in1Sub9601,in0Mul86468,in1Mul86468], outputs=Con16308)
w = model.get_layer('Con57531').get_weights() 
w[0] = np.array([[[[[0.9123, 0.1731, 0.2907]]]]])
w[1] = np.array([0, 0, 0])
model.get_layer('Con57531').set_weights(w) 
w = model.get_layer('Con16308').get_weights() 
w[0] = np.array([[[[0.6232, 0.2927, 0.9426]], [[0.55, 0.9562, 0.298]]], [[[0.9999, 0.4362, 0.1797]], [[0.2558, 0.4809, 0.7603]]]])
w[1] = np.array([0, 0, 0])
model.get_layer('Con16308').set_weights(w) 
in0Sub9601 = tf.constant([[[[0.7569, 0.4443, 0.5253], [0.1071, 0.6577, 0.3013], [0.8317, 0.4386, 0.3091]], [[0.4894, 0.5476, 0.8482], [0.8882, 0.462, 0.3692], [0.2609, 0.0151, 0.3148]]]])
in1Sub9601 = tf.constant([[[[0.2662, 0.0518, 0.0712], [0.2329, 0.9491, 0.6301], [0.5897, 0.6959, 0.2246]], [[0.1693, 0.6389, 0.0154], [0.7724, 0.3474, 0.9733], [0.8008, 0.1157, 0.99]]]])
in0Mul86468 = tf.constant([[[[0.6097], [0.2431]], [[0.3357], [0.3274]]]])
in1Mul86468 = tf.constant([[[[0.4008], [0.6884]], [[0.3843], [0.1655]]]])
print (np.array2string(model.predict([in0Sub9601,in1Sub9601,in0Mul86468,in1Mul86468],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Con16308.png')

LSub9601 = subtract_layer([[[[0.7569, 0.4443, 0.5253], [0.1071, 0.6577, 0.3013], [0.8317, 0.4386, 0.3091]], [[0.4894, 0.5476, 0.8482], [0.8882, 0.462, 0.3692], [0.2609, 0.0151, 0.3148]]]], [[[[0.2662, 0.0518, 0.0712], [0.2329, 0.9491, 0.6301], [0.5897, 0.6959, 0.2246]], [[0.1693, 0.6389, 0.0154], [0.7724, 0.3474, 0.9733], [0.8008, 0.1157, 0.99]]]], Sub9601), 
LRes29051 = reshape_layer(Sub9601, [2, 9], Res29051), 
LMul86468 = multiply_layer([[[[[0.6097], [0.2431]], [[0.3357], [0.3274]]]], [[[[0.4008], [0.6884]], [[0.3843], [0.1655]]]]], Mul86468), 
LRes45974 = reshape_layer(Mul86468, [2, 2, 1, 1], Res45974), 
LGlo36373 = global_max_pool3D_layer(Res45974, Glo36373), 
LRes39617 = reshape_layer(Glo36373, [1, 1], Res39617), 
LRes8079 = reshape_layer(Res39617, [1, 1, 1], Res8079), 
LRes60707 = reshape_layer(Res8079, [1, 1, 1, 1], Res60707), 
LCon57531 = conv3D_layer(Res60707, 1, 1, 1,[[[[[0.9123, 0.1731, 0.2907]]]]],[0, 0, 0], 1, 3, 6, true, 1, 1, 1, Con57531), 
LRes49414 = reshape_layer(Con57531, [1, 1, 3], Res49414), 
LRes34865 = reshape_layer(Res49414, [1, 3], Res34865), 
LZer24573 = zero_padding1D_layer(Res34865, 1, 0, Zer24573), 
LDot35261 = dot_layer(Res29051,Zer24573, 1, 1, Dot35261), 
LRes93135 = reshape_layer(Dot35261, [9, 3, 1], Res93135), 
LCon16308 = conv2D_layer(Res93135, 2, 2,[[[[0.6232, 0.2927, 0.9426]], [[0.55, 0.9562, 0.298]]], [[[0.9999, 0.4362, 0.1797]], [[0.2558, 0.4809, 0.7603]]]],[0, 0, 0], 5, 1, false, 1, 1, Con16308), 
exec_layers([LSub9601,LRes29051,LMul86468,LRes45974,LGlo36373,LRes39617,LRes8079,LRes60707,LCon57531,LRes49414,LRes34865,LZer24573,LDot35261,LRes93135,LCon16308],["Sub9601","Res29051","Mul86468","Res45974","Glo36373","Res39617","Res8079","Res60707","Con57531","Res49414","Res34865","Zer24573","Dot35261","Res93135","Con16308"],Con16308,"Con16308")

Actual (Unparsed): [[[[0.0305800, 0.0230992, 0.0647069], [0.0154242, 0.0209028, 0.0139142]], [[-0.2241779, -0.1273392, -0.1735535], [-0.0721738, -0.0769197, -0.0701390]]]]

Expected (Unparsed): [[[[0.03057997589027315,0.023099153843867376,0.06470694242335537],[0.015424164609521585,0.02090282941742211,0.013914200650589757]],[[-0.22417793162496705,-0.12733917825607222,-0.17355349854693147],[-0.07217383522592953,-0.07691968204830249,-0.0701389683156324]]]]

Actual:   [[[[0.0306, 0.0231, 0.0648], [0.0155, 0.021, 0.014]], [[-0.2241, -0.1273, -0.1735], [-0.0721, -0.0769, -0.0701]]]]

Expected: [[[[0.0306, 0.0231, 0.0648], [0.0155, 0.021, 0.014]], [[-0.2241, -0.1273, -0.1735], [-0.0721, -0.0769, -0.0701]]]]