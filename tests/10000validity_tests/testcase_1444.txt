import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0Fla66261 = tf.keras.layers.Input(shape=([2, 2, 4]))
in0Con38628 = tf.keras.layers.Input(shape=([16, 2]))
in0Dot48239 = tf.keras.layers.Input(shape=([2]))
in1Dot48239 = tf.keras.layers.Input(shape=([2]))

Fla66261 = keras.layers.Flatten(name = 'Fla66261', )(in0Fla66261)
Res64433 = keras.layers.Reshape((16, 1), name = 'Res64433', )(Fla66261)
Con38628 = keras.layers.Concatenate(axis=2, name = 'Con38628', )([Res64433,in0Con38628])
Dot48239 = keras.layers.Dot(axes=(1, 1), name = 'Dot48239', )([in0Dot48239,in1Dot48239])
Res16159 = keras.layers.Reshape((1, 1), name = 'Res16159', )(Dot48239)
Res40105 = keras.layers.Reshape((1, 1, 1), name = 'Res40105', )(Res16159)
Res12723 = keras.layers.Reshape((1, 1, 1, 1), name = 'Res12723', )(Res40105)
Con18250 = keras.layers.Conv3D(4, (1, 1, 1),strides=(1, 1, 1), padding='same', dilation_rate=(1, 1, 1), name = 'Con18250', )(Res12723)
Res1141 = keras.layers.Reshape((1, 1, 4), name = 'Res1141', )(Con18250)
Con40100 = keras.layers.Conv2DTranspose(3, (1, 1),strides=(1, 1), padding='same', name = 'Con40100', )(Res1141)
Res67945 = keras.layers.Reshape((1, 3), name = 'Res67945', )(Con40100)
Dot32730 = keras.layers.Dot(axes=(2, 2), name = 'Dot32730', )([Con38628,Res67945])
Per44122 = keras.layers.Permute((2,1), name = 'Per44122',)(Dot32730)
model = tf.keras.models.Model(inputs=[in0Fla66261,in0Con38628,in0Dot48239,in1Dot48239], outputs=Per44122)
w = model.get_layer('Con18250').get_weights() 
w[0] = np.array([[[[[0.3658, 0.6782, 0.6478, 0.5146]]]]])
w[1] = np.array([0, 0, 0, 0])
model.get_layer('Con18250').set_weights(w) 
w = model.get_layer('Con40100').get_weights() 
w[0] = np.array([[[[0.8098, 0.7823, 0.3502, 0.2335], [0.803, 0.5988, 0.4888, 0.8078], [0.1486, 0.9153, 0.7368, 0.9847]]]])
w[1] = np.array([0, 0, 0])
model.get_layer('Con40100').set_weights(w) 
in0Fla66261 = tf.constant([[[[1.2841, 1.143, 1.0059, 1.9123], [1.6663, 1.2873, 1.2788, 1.3631]], [[1.8655, 1.5416, 1.0552, 1.7517], [1.761, 1.9541, 1.0209, 1.5567]]]])
in0Con38628 = tf.constant([[[0.1291, 0.7798], [0.9997, 0.4322], [0.949, 0.3296], [0.9991, 0.3082], [0.9997, 0.7829], [0.8027, 0.2666], [0.9207, 0.2173], [0.8788, 0.5832], [0.5829, 0.2311], [0.4989, 0.9065], [0.7977, 0.4458], [0.5958, 0.9629], [0.202, 0.5241], [0.7494, 0.1303], [0.5931, 0.4213], [0.4285, 0.5194]]])
in0Dot48239 = tf.constant([[0.1474, 0.4041]])
in1Dot48239 = tf.constant([[0.5357, 0.311]])
print (np.array2string(model.predict([in0Fla66261,in0Con38628,in0Dot48239,in1Dot48239],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Per44122.png')

LFla66261 = flatten_layer([[[[1.2841, 1.143, 1.0059, 1.9123], [1.6663, 1.2873, 1.2788, 1.3631]], [[1.8655, 1.5416, 1.0552, 1.7517], [1.761, 1.9541, 1.0209, 1.5567]]]], Fla66261), 
LRes64433 = reshape_layer(Fla66261, [16, 1], Res64433), 
LCon38628 = concatenate_layer([Res64433,[[[0.1291, 0.7798], [0.9997, 0.4322], [0.949, 0.3296], [0.9991, 0.3082], [0.9997, 0.7829], [0.8027, 0.2666], [0.9207, 0.2173], [0.8788, 0.5832], [0.5829, 0.2311], [0.4989, 0.9065], [0.7977, 0.4458], [0.5958, 0.9629], [0.202, 0.5241], [0.7494, 0.1303], [0.5931, 0.4213], [0.4285, 0.5194]]]], 2, Con38628), 
LDot48239 = dot_layer([[0.1474, 0.4041]], [[0.5357, 0.311]], 1, 1, Dot48239), 
LRes16159 = reshape_layer(Dot48239, [1, 1], Res16159), 
LRes40105 = reshape_layer(Res16159, [1, 1, 1], Res40105), 
LRes12723 = reshape_layer(Res40105, [1, 1, 1, 1], Res12723), 
LCon18250 = conv3D_layer(Res12723, 1, 1, 1,[[[[[0.3658, 0.6782, 0.6478, 0.5146]]]]],[0, 0, 0, 0], 1, 1, 1, true, 1, 1, 1, Con18250), 
LRes1141 = reshape_layer(Con18250, [1, 1, 4], Res1141), 
LCon40100 = conv2D_transpose_layer(Res1141, 1, 1,[[[[0.8098, 0.7823, 0.3502, 0.2335], [0.803, 0.5988, 0.4888, 0.8078], [0.1486, 0.9153, 0.7368, 0.9847]]]],[0, 0, 0], 1, 1, true, Con40100), 
LRes67945 = reshape_layer(Con40100, [1, 3], Res67945), 
LDot32730 = dot_layer(Con38628,Res67945, 2, 2, Dot32730), 
LPer44122 = permute_layer(Dot32730, 2,1, Per44122), 
exec_layers([LFla66261,LRes64433,LCon38628,LDot48239,LRes16159,LRes40105,LRes12723,LCon18250,LRes1141,LCon40100,LRes67945,LDot32730,LPer44122],["Fla66261","Res64433","Con38628","Dot48239","Res16159","Res40105","Res12723","Con18250","Res1141","Con40100","Res67945","Dot32730","Per44122"],Per44122,"Per44122")

Actual (Unparsed): [[[0.6110404, 0.7142835, 0.6316576, 0.8567951, 0.9590521, 0.6349836, 0.6507866, 0.7829868, 0.6973975, 0.8242903, 0.6386094, 0.9223052, 0.6601428, 0.7332532, 0.5620884, 0.6758557]]]

Expected (Unparsed): [[[0.6110403362705907,0.7142834385155189,0.6316575990051577,0.8567951278248896,0.9590520542733267,0.6349835854153998,0.6507866152329211,0.7829868375604212,0.6973974848975426,0.8242902481715392,0.6386093786489504,0.9223051994117641,0.660142824544339,0.7332531343463737,0.5620883984126406,0.6758557085688242]]]

Actual:   [[[0.6111, 0.7143, 0.6317, 0.8568, 0.9591, 0.635, 0.6508, 0.783, 0.6974, 0.8243, 0.6387, 0.9224, 0.6602, 0.7333, 0.5621, 0.6759]]]

Expected: [[[0.6111, 0.7143, 0.6317, 0.8568, 0.9591, 0.635, 0.6508, 0.783, 0.6974, 0.8243, 0.6387, 0.9224, 0.6602, 0.7333, 0.5621, 0.6759]]]