import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0Ave8710 = tf.keras.layers.Input(shape=([1, 2, 2, 2]))
in1Ave8710 = tf.keras.layers.Input(shape=([1, 2, 2, 2]))
in0LST12858 = tf.keras.layers.Input(shape=([2, 1]))
in0Con30845 = tf.keras.layers.Input(shape=([5]))

Ave8710 = keras.layers.Average(name = 'Ave8710', )([in0Ave8710,in1Ave8710])
Res27188 = keras.layers.Reshape((1, 2, 4), name = 'Res27188', )(Ave8710)
Res71656 = keras.layers.Reshape((1, 8), name = 'Res71656', )(Res27188)
Fla62881 = keras.layers.Flatten(name = 'Fla62881', )(Res71656)
Res53079 = keras.layers.Reshape((8, 1), name = 'Res53079', )(Fla62881)
Res47355 = keras.layers.Reshape((8, 1, 1), name = 'Res47355', )(Res53079)
Cro59030 = keras.layers.Cropping2D(cropping=((0, 0), (0, 0)), name = 'Cro59030', )(Res47355)
Res38502 = keras.layers.Reshape((8, 1), name = 'Res38502', )(Cro59030)
Fla93640 = keras.layers.Flatten(name = 'Fla93640', )(Res38502)
LST12858 = keras.layers.LSTM(3,recurrent_activation='sigmoid', name = 'LST12858', )(in0LST12858)
Con30845 = keras.layers.Concatenate(axis=1, name = 'Con30845', )([LST12858,in0Con30845])
Sub78685 = keras.layers.Subtract(name = 'Sub78685', )([Fla93640,Con30845])
model = tf.keras.models.Model(inputs=[in0Ave8710,in1Ave8710,in0LST12858,in0Con30845], outputs=Sub78685)
w = model.get_layer('LST12858').get_weights() 
w[0] = np.array([[5, 6, 6, 8, 3, 2, 2, 7, 6, 3, 8, 6]])
w[1] = np.array([[4, 5, 6, 7, 9, 8, 5, 3, 6, 6, 4, 5], [5, 8, 3, 1, 2, 6, 7, 9, 3, 7, 5, 9], [2, 10, 10, 3, 2, 6, 3, 2, 8, 10, 6, 6]])
w[2] = np.array([6, 9, 4, 3, 1, 10, 5, 7, 1, 4, 2, 10])
model.get_layer('LST12858').set_weights(w) 
in0Ave8710 = tf.constant([[[[[0.4878, 0.4108], [0.725, 0.5284]], [[0.5128, 0.3744], [0.289, 0.2063]]]]])
in1Ave8710 = tf.constant([[[[[0.9773, 0.2224], [0.5157, 0.331]], [[0.3063, 0.3924], [0.9378, 0.5529]]]]])
in0LST12858 = tf.constant([[[8], [5]]])
in0Con30845 = tf.constant([[0.7073, 0.1254, 0.7699, 0.3217, 0.0683]])
print (np.array2string(model.predict([in0Ave8710,in1Ave8710,in0LST12858,in0Con30845],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Sub78685.png')

LAve8710 = average_layer([[[[[[0.4878, 0.4108], [0.725, 0.5284]], [[0.5128, 0.3744], [0.289, 0.2063]]]]], [[[[[0.9773, 0.2224], [0.5157, 0.331]], [[0.3063, 0.3924], [0.9378, 0.5529]]]]]], Ave8710), 
LRes27188 = reshape_layer(Ave8710, [1, 2, 4], Res27188), 
LRes71656 = reshape_layer(Res27188, [1, 8], Res71656), 
LFla62881 = flatten_layer(Res71656, Fla62881), 
LRes53079 = reshape_layer(Fla62881, [8, 1], Res53079), 
LRes47355 = reshape_layer(Res53079, [8, 1, 1], Res47355), 
LCro59030 = cropping2D_layer(Res47355, 0, 0, 0, 0, Cro59030), 
LRes38502 = reshape_layer(Cro59030, [8, 1], Res38502), 
LFla93640 = flatten_layer(Res38502, Fla93640), 
LLST12858 = lstm_layer([[[8], [5]]],[[5, 6, 6, 8, 3, 2, 2, 7, 6, 3, 8, 6]],[[4, 5, 6, 7, 9, 8, 5, 3, 6, 6, 4, 5], [5, 8, 3, 1, 2, 6, 7, 9, 3, 7, 5, 9], [2, 10, 10, 3, 2, 6, 3, 2, 8, 10, 6, 6]],[6, 9, 4, 3, 1, 10, 5, 7, 1, 4, 2, 10], LST12858), 
LCon30845 = concatenate_layer([LST12858,[[0.7073, 0.1254, 0.7699, 0.3217, 0.0683]]], 1, Con30845), 
LSub78685 = subtract_layer(Fla93640,Con30845, Sub78685), 
exec_layers([LAve8710,LRes27188,LRes71656,LFla62881,LRes53079,LRes47355,LCro59030,LRes38502,LFla93640,LLST12858,LCon30845,LSub78685],["Ave8710","Res27188","Res71656","Fla62881","Res53079","Res47355","Cro59030","Res38502","Fla93640","LST12858","Con30845","Sub78685"],Sub78685,"Sub78685")

Actual (Unparsed): [[-0.2314776, -0.6474276, -0.3436776, -0.2776000, 0.2841500, -0.3865000, 0.2917000, 0.3113000]]

Expected (Unparsed): [[-0.23147758007581665,-0.6474275800754182,-0.34367758007581695,-0.27760000000000007,0.28415,-0.3865,0.29169999999999996,0.3113]]

Actual:   [[-0.2314, -0.6474, -0.3436, -0.2776, 0.2842, -0.3865, 0.2917, 0.3113]]

Expected: [[-0.2314, -0.6474, -0.3436, -0.2776, 0.2842, -0.3865, 0.2917, 0.3113]]