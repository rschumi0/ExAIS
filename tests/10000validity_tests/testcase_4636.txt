import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0Add39228 = tf.keras.layers.Input(shape=([2, 2, 1, 2]))
in1Add39228 = tf.keras.layers.Input(shape=([2, 2, 1, 2]))
in0Ave85312 = tf.keras.layers.Input(shape=([1, 2, 2, 2]))
in1Ave85312 = tf.keras.layers.Input(shape=([1, 2, 2, 2]))

Add39228 = keras.layers.Add(name = 'Add39228', )([in0Add39228,in1Add39228])
Res78747 = keras.layers.Reshape((2, 2, 2), name = 'Res78747', )(Add39228)
Ave85312 = keras.layers.Average(name = 'Ave85312', )([in0Ave85312,in1Ave85312])
Res80234 = keras.layers.Reshape((1, 2, 4), name = 'Res80234', )(Ave85312)
Res16238 = keras.layers.Reshape((1, 8), name = 'Res16238', )(Res80234)
Glo38298 = keras.layers.GlobalAveragePooling1D(name = 'Glo38298', )(Res16238)
Sof40417 = keras.layers.Softmax(axis=1, name = 'Sof40417', )(Glo38298)
Res91808 = keras.layers.Reshape((2, 2, 2), name = 'Res91808', )(Sof40417)
Min2622 = keras.layers.Minimum(name = 'Min2622', )([Res78747,Res91808])
Res2863 = keras.layers.Reshape((2, 4), name = 'Res2863', )(Min2622)
Per9099 = keras.layers.Permute((2,1), name = 'Per9099',)(Res2863)
model = tf.keras.models.Model(inputs=[in0Add39228,in1Add39228,in0Ave85312,in1Ave85312], outputs=Per9099)
in0Add39228 = tf.constant([[[[[0.6454, 0.8845]], [[0.7541, 0.0035]]], [[[0.867, 0.5174]], [[0.5545, 0.1287]]]]])
in1Add39228 = tf.constant([[[[[0.699, 0.4933]], [[0.5511, 0.3858]]], [[[0.9019, 0.7659]], [[0.6, 0.9485]]]]])
in0Ave85312 = tf.constant([[[[[0.9602, 0.1646], [0.8797, 0.7804]], [[0.3789, 0.8699], [0.069, 0.9797]]]]])
in1Ave85312 = tf.constant([[[[[0.8017, 0.9961], [0.6404, 0.4484]], [[0.791, 0.2188], [0.3202, 0.071]]]]])
print (np.array2string(model.predict([in0Add39228,in1Add39228,in0Ave85312,in1Ave85312],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Per9099.png')

LAdd39228 = add_layer([[[[[[0.6454, 0.8845]], [[0.7541, 0.0035]]], [[[0.867, 0.5174]], [[0.5545, 0.1287]]]]], [[[[[0.699, 0.4933]], [[0.5511, 0.3858]]], [[[0.9019, 0.7659]], [[0.6, 0.9485]]]]]], Add39228), 
LRes78747 = reshape_layer(Add39228, [2, 2, 2], Res78747), 
LAve85312 = average_layer([[[[[[0.9602, 0.1646], [0.8797, 0.7804]], [[0.3789, 0.8699], [0.069, 0.9797]]]]], [[[[[0.8017, 0.9961], [0.6404, 0.4484]], [[0.791, 0.2188], [0.3202, 0.071]]]]]], Ave85312), 
LRes80234 = reshape_layer(Ave85312, [1, 2, 4], Res80234), 
LRes16238 = reshape_layer(Res80234, [1, 8], Res16238), 
LGlo38298 = global_average_pooling1D_layer(Res16238, Glo38298), 
LSof40417 = softmax_layer(Glo38298, 1, Sof40417), 
LRes91808 = reshape_layer(Sof40417, [2, 2, 2], Res91808), 
LMin2622 = minimum_layer([Res78747,Res91808], Min2622), 
LRes2863 = reshape_layer(Min2622, [2, 4], Res2863), 
LPer9099 = permute_layer(Res2863, 2,1, Per9099), 
exec_layers([LAdd39228,LRes78747,LAve85312,LRes80234,LRes16238,LGlo38298,LSof40417,LRes91808,LMin2622,LRes2863,LPer9099],["Add39228","Res78747","Ave85312","Res80234","Res16238","Glo38298","Sof40417","Res91808","Min2622","Res2863","Per9099"],Per9099,"Per9099")

Actual (Unparsed): [[[0.1651621, 0.1228455], [0.1222817, 0.1179578], [0.1463538, 0.0831443], [0.1265171, 0.1157378]]]

Expected (Unparsed): [[[0.16516206630544772,0.12284546850382733],[0.12228167706317511,0.1179578328498297],[0.14635383423483558,0.0831442633661056],[0.12651706646963953,0.11573779120713942]]]

Actual:   [[[0.1652, 0.1229], [0.1223, 0.118], [0.1464, 0.0832], [0.1266, 0.1158]]]

Expected: [[[0.1652, 0.1229], [0.1223, 0.118], [0.1464, 0.0832], [0.1266, 0.1158]]]