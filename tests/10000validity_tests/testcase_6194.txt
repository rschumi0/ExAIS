import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0Dot94900 = tf.keras.layers.Input(shape=([3]))
in1Dot94900 = tf.keras.layers.Input(shape=([3]))
in0Con31198 = tf.keras.layers.Input(shape=([1]))
in0Dot6445 = tf.keras.layers.Input(shape=([2, 3]))
in1Dot6445 = tf.keras.layers.Input(shape=([2, 3]))
in0Con66089 = tf.keras.layers.Input(shape=([3, 1, 3]))
in0Min30268 = tf.keras.layers.Input(shape=([2, 1]))
in1Min30268 = tf.keras.layers.Input(shape=([2, 1]))

Dot94900 = keras.layers.Dot(axes=(1, 1), name = 'Dot94900', )([in0Dot94900,in1Dot94900])
Con31198 = keras.layers.Concatenate(axis=1, name = 'Con31198', )([Dot94900,in0Con31198])
Dot6445 = keras.layers.Dot(axes=(2, 2), name = 'Dot6445', )([in0Dot6445,in1Dot6445])
Sim9950 = keras.layers.SimpleRNN(2,name = 'Sim9950', )(Dot6445)
Max98589 = keras.layers.Maximum(name = 'Max98589', )([Con31198,Sim9950])
Res10473 = keras.layers.Reshape((2, 1), name = 'Res10473', )(Max98589)
Res418 = keras.layers.Reshape((2, 1, 1), name = 'Res418', )(Res10473)
Zer74552 = keras.layers.ZeroPadding2D(padding=((1, 0), (0, 0)), name = 'Zer74552', )(Res418)
Con66089 = keras.layers.Concatenate(axis=3, name = 'Con66089', )([Zer74552,in0Con66089])
Min30268 = keras.layers.Minimum(name = 'Min30268', )([in0Min30268,in1Min30268])
Res73110 = keras.layers.Reshape((2, 1, 1), name = 'Res73110', )(Min30268)
Res95973 = keras.layers.Reshape((2, 1, 1, 1), name = 'Res95973', )(Res73110)
Con29830 = keras.layers.Conv3DTranspose(4, (2, 1, 1),strides=(1, 1, 1), padding='valid', name = 'Con29830', )(Res95973)
Res34516 = keras.layers.Reshape((3, 1, 4), name = 'Res34516', )(Con29830)
Max7007 = keras.layers.MaxPool2D(pool_size=(1, 1), strides=(1, 1), padding='valid', name = 'Max7007', )(Res34516)
Add97223 = keras.layers.Add(name = 'Add97223', )([Con66089,Max7007])
model = tf.keras.models.Model(inputs=[in0Dot94900,in1Dot94900,in0Con31198,in0Dot6445,in1Dot6445,in0Con66089,in0Min30268,in1Min30268], outputs=Add97223)
w = model.get_layer('Sim9950').get_weights() 
w[0] = np.array([[3, 9], [7, 4]])
w[1] = np.array([[2, 6], [1, 8]])
w[2] = np.array([3, 7])
model.get_layer('Sim9950').set_weights(w) 
w = model.get_layer('Con29830').get_weights() 
w[0] = np.array([[[[[0.9187], [0.1], [0.4744], [0.8879]]]], [[[[0.4972], [0.4967], [0.939], [0.1161]]]]])
w[1] = np.array([0, 0, 0, 0])
model.get_layer('Con29830').set_weights(w) 
in0Dot94900 = tf.constant([[0.1249, 0.4801, 0.9021]])
in1Dot94900 = tf.constant([[0.7148, 0.8328, 0.1588]])
in0Con31198 = tf.constant([[0.4747]])
in0Dot6445 = tf.constant([[[0.9815, 0.9331, 0.8329], [0.4033, 0.2244, 0.9553]]])
in1Dot6445 = tf.constant([[[0.7927, 0.4045, 0.2403], [0.1578, 0.6332, 0.431]]])
in0Con66089 = tf.constant([[[[0.287, 0.9051, 0.5114]], [[0.4139, 0.8834, 0.0145]], [[0.9514, 0.6884, 0.0088]]]])
in0Min30268 = tf.constant([[[0.7238], [0.2971]]])
in1Min30268 = tf.constant([[[0.1443], [0.807]]])
print (np.array2string(model.predict([in0Dot94900,in1Dot94900,in0Con31198,in0Dot6445,in1Dot6445,in0Con66089,in0Min30268,in1Min30268],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Add97223.png')

LDot94900 = dot_layer([[0.1249, 0.4801, 0.9021]], [[0.7148, 0.8328, 0.1588]], 1, 1, Dot94900), 
LCon31198 = concatenate_layer([Dot94900,[[0.4747]]], 1, Con31198), 
LDot6445 = dot_layer([[[0.9815, 0.9331, 0.8329], [0.4033, 0.2244, 0.9553]]], [[[0.7927, 0.4045, 0.2403], [0.1578, 0.6332, 0.431]]], 2, 2, Dot6445), 
LSim9950 = simple_rnn_layer(Dot6445,[[3, 9], [7, 4]],[[2, 6], [1, 8]],[3, 7], Sim9950), 
LMax98589 = maximum_layer([Con31198,Sim9950], Max98589), 
LRes10473 = reshape_layer(Max98589, [2, 1], Res10473), 
LRes418 = reshape_layer(Res10473, [2, 1, 1], Res418), 
LZer74552 = zero_padding2D_layer(Res418, 1, 0, 0, 0, Zer74552), 
LCon66089 = concatenate_layer([Zer74552,[[[[0.287, 0.9051, 0.5114]], [[0.4139, 0.8834, 0.0145]], [[0.9514, 0.6884, 0.0088]]]]], 3, Con66089), 
LMin30268 = minimum_layer([[[[0.7238], [0.2971]]], [[[0.1443], [0.807]]]], Min30268), 
LRes73110 = reshape_layer(Min30268, [2, 1, 1], Res73110), 
LRes95973 = reshape_layer(Res73110, [2, 1, 1, 1], Res95973), 
LCon29830 = conv3D_transpose_layer(Res95973, 2, 1, 1,[[[[[0.9187], [0.1], [0.4744], [0.8879]]]], [[[[0.4972], [0.4967], [0.939], [0.1161]]]]],[0, 0, 0, 0], 1, 1, 1, false, Con29830), 
LRes34516 = reshape_layer(Con29830, [3, 1, 4], Res34516), 
LMax7007 = max_pool2D_layer(Res34516, 1, 1, 1, 1, false, Max7007), 
LAdd97223 = add_layer([Con66089,Max7007], Add97223), 
exec_layers([LDot94900,LCon31198,LDot6445,LSim9950,LMax98589,LRes10473,LRes418,LZer74552,LCon66089,LMin30268,LRes73110,LRes95973,LCon29830,LRes34516,LMax7007,LAdd97223],["Dot94900","Con31198","Dot6445","Sim9950","Max98589","Res10473","Res418","Zer74552","Con66089","Min30268","Res73110","Res95973","Con29830","Res34516","Max7007","Add97223"],Add97223,"Add97223")

Actual (Unparsed): [[[[0.1325684, 0.3014300, 0.9735559, 0.6395240]], [[1.3446917, 0.5152838, 1.1598420, 0.2950483]], [[1.1477181, 1.0989696, 0.9673769, 0.0432933]]]]

Expected (Unparsed): [[[[0.13256841,0.30143,0.97355592,0.6395239699999999]],[[1.3446917299534973,0.51528381,1.15984194,0.29504832000000003]],[[1.14771812,1.09896957,0.9673769,0.043293309999999995]]]]

Actual:   [[[[0.1326, 0.3015, 0.9736, 0.6396]], [[1.3447, 0.5153, 1.1599, 0.2951]], [[1.1478, 1.099, 0.9674, 0.0433]]]]

Expected: [[[[0.1326, 0.3015, 0.9736, 0.6396]], [[1.3447, 0.5153, 1.1599, 0.2951]], [[1.1478, 1.099, 0.9674, 0.0433]]]]