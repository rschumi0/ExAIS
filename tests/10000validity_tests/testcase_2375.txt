import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0Glo31904 = tf.keras.layers.Input(shape=([2, 1, 2, 2]))
in0Max2288 = tf.keras.layers.Input(shape=([2, 2, 2, 1]))
in1Max2288 = tf.keras.layers.Input(shape=([2, 2, 2, 1]))

Glo31904 = keras.layers.GlobalMaxPool3D(name = 'Glo31904', )(in0Glo31904)
Res1984 = keras.layers.Reshape((2, 1), name = 'Res1984', )(Glo31904)
Res4393 = keras.layers.Reshape((2, 1, 1), name = 'Res4393', )(Res1984)
Res96618 = keras.layers.Reshape((2, 1, 1, 1), name = 'Res96618', )(Res4393)
Con88558 = keras.layers.Conv3D(4, (2, 1, 1),strides=(1, 1, 1), padding='valid', dilation_rate=(1, 1, 1), name = 'Con88558', )(Res96618)
Res84006 = keras.layers.Reshape((1, 1, 4), name = 'Res84006', )(Con88558)
Loc36170 = keras.layers.LocallyConnected2D(4, (1, 1),strides=(1, 1), name = 'Loc36170', )(Res84006)
Res80690 = keras.layers.Reshape((1, 1, 4, 1), name = 'Res80690', )(Loc36170)
Zer45661 = keras.layers.ZeroPadding3D(padding=((1, 0), (1, 0), (2, 0)), name = 'Zer45661', )(Res80690)
Max2288 = keras.layers.Maximum(name = 'Max2288', )([in0Max2288,in1Max2288])
Up_42937 = keras.layers.UpSampling3D(size=(1, 1, 1), name = 'Up_42937', )(Max2288)
Zer76807 = keras.layers.ZeroPadding3D(padding=((0, 0), (0, 0), (4, 0)), name = 'Zer76807', )(Up_42937)
Ave97055 = keras.layers.Average(name = 'Ave97055', )([Zer45661,Zer76807])
model = tf.keras.models.Model(inputs=[in0Glo31904,in0Max2288,in1Max2288], outputs=Ave97055)
w = model.get_layer('Con88558').get_weights() 
w[0] = np.array([[[[[0.6968, 0.9077, 0.4478, 0.0927]]]], [[[[0.9822, 0.2486, 0.5992, 0.3385]]]]])
w[1] = np.array([0, 0, 0, 0])
model.get_layer('Con88558').set_weights(w) 
w = model.get_layer('Loc36170').get_weights() 
w[0] = np.array([[[0.0847, 0.509, 0.2336, 0.4754], [0.251, 0.3751, 0.8791, 0.6467], [0.5387, 0.1214, 0.3906, 0.6279], [0.6928, 0.2639, 0.7554, 0.4791]]])
w[1] = np.array([[[0, 0, 0, 0]]])
model.get_layer('Loc36170').set_weights(w) 
in0Glo31904 = tf.constant([[[[[1.3282, 1.4765], [1.0188, 1.2439]]], [[[1.5135, 1.0668], [1.1052, 1.3716]]]]])
in0Max2288 = tf.constant([[[[[0.8225], [0.0508]], [[0.2548], [0.8236]]], [[[0.0448], [0.1949]], [[0.7455], [0.3576]]]]])
in1Max2288 = tf.constant([[[[[0.3619], [0.9377]], [[0.3216], [0.6514]]], [[[0.0345], [0.5892]], [[0.4963], [0.6918]]]]])
print (np.array2string(model.predict([in0Glo31904,in0Max2288,in1Max2288],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Ave97055.png')

LGlo31904 = global_max_pool3D_layer([[[[[1.3282, 1.4765], [1.0188, 1.2439]]], [[[1.5135, 1.0668], [1.1052, 1.3716]]]]], Glo31904), 
LRes1984 = reshape_layer(Glo31904, [2, 1], Res1984), 
LRes4393 = reshape_layer(Res1984, [2, 1, 1], Res4393), 
LRes96618 = reshape_layer(Res4393, [2, 1, 1, 1], Res96618), 
LCon88558 = conv3D_layer(Res96618, 2, 1, 1,[[[[[0.6968, 0.9077, 0.4478, 0.0927]]]], [[[[0.9822, 0.2486, 0.5992, 0.3385]]]]],[0, 0, 0, 0], 1, 1, 1, false, 1, 1, 1, Con88558), 
LRes84006 = reshape_layer(Con88558, [1, 1, 4], Res84006), 
LLoc36170 = locally_connected2D_layer(Res84006, 1, 1,[[[0.0847, 0.509, 0.2336, 0.4754], [0.251, 0.3751, 0.8791, 0.6467], [0.5387, 0.1214, 0.3906, 0.6279], [0.6928, 0.2639, 0.7554, 0.4791]]],[[[0, 0, 0, 0]]], 1, 1, Loc36170), 
LRes80690 = reshape_layer(Loc36170, [1, 1, 4, 1], Res80690), 
LZer45661 = zero_padding3D_layer(Res80690, 1, 0, 1, 0, 2, 0, Zer45661), 
LMax2288 = maximum_layer([[[[[[0.8225], [0.0508]], [[0.2548], [0.8236]]], [[[0.0448], [0.1949]], [[0.7455], [0.3576]]]]], [[[[[0.3619], [0.9377]], [[0.3216], [0.6514]]], [[[0.0345], [0.5892]], [[0.4963], [0.6918]]]]]], Max2288), 
LUp_42937 = up_sampling3D_layer(Max2288, 1, 1, 1, Up_42937), 
LZer76807 = zero_padding3D_layer(Up_42937, 0, 0, 0, 0, 4, 0, Zer76807), 
LAve97055 = average_layer([Zer45661,Zer76807], Ave97055), 
exec_layers([LGlo31904,LRes1984,LRes4393,LRes96618,LCon88558,LRes84006,LLoc36170,LRes80690,LZer45661,LMax2288,LUp_42937,LZer76807,LAve97055],["Glo31904","Res1984","Res4393","Res96618","Con88558","Res84006","Loc36170","Res80690","Zer45661","Max2288","Up_42937","Zer76807","Ave97055"],Ave97055,"Ave97055")

Actual (Unparsed): [[[[[0.0000000], [0.0000000], [0.0000000], [0.0000000], [0.4112500], [0.4688500]], [[0.0000000], [0.0000000], [0.0000000], [0.0000000], [0.1608000], [0.4118000]]], [[[0.0000000], [0.0000000], [0.0000000], [0.0000000], [0.0224000], [0.2946000]], [[0.0000000], [0.0000000], [0.9671367], [1.1432790], [1.9774232], [2.1480754]]]]]

Expected (Unparsed): [[[[[0],[0],[0],[0],[0.41125],[0.46885]],[[0],[0],[0],[0],[0.1608],[0.4118]]],[[[0],[0],[0],[0],[0.0224],[0.2946]],[[0],[0],[0.9671367073749999],[1.1432789583524998],[1.9774231601675],[2.1480753741475]]]]]

Actual:   [[[[[0], [0], [0], [0], [0.4113], [0.4689]], [[0], [0], [0], [0], [0.1608], [0.4118]]], [[[0], [0], [0], [0], [0.0224], [0.2946]], [[0], [0], [0.9672], [1.1433], [1.9775], [2.1481]]]]]

Expected: [[[[[0], [0], [0], [0], [0.4113], [0.4689]], [[0], [0], [0], [0], [0.1608], [0.4118]]], [[[0], [0], [0], [0], [0.0224], [0.2946]], [[0], [0], [0.9672], [1.1433], [1.9775], [2.1481]]]]]