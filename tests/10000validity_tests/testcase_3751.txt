import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0Con85187 = tf.keras.layers.Input(shape=([2, 2, 2, 1]))
in0Con35384 = tf.keras.layers.Input(shape=([1, 3]))
in0Add49090 = tf.keras.layers.Input(shape=([1, 2]))
in1Add49090 = tf.keras.layers.Input(shape=([1, 2]))

Con85187 = keras.layers.Conv3D(4, (2, 1, 2),strides=(1, 1, 1), padding='valid', dilation_rate=(1, 1, 1), name = 'Con85187', )(in0Con85187)
Res18262 = keras.layers.Reshape((1, 2, 4), name = 'Res18262', )(Con85187)
Sep62510 = keras.layers.SeparableConv2D(2, (1, 1),strides=(1, 1), padding='valid', name = 'Sep62510', )(Res18262)
Res63255 = keras.layers.Reshape((1, 4), name = 'Res63255', )(Sep62510)
Con35384 = keras.layers.Concatenate(axis=2, name = 'Con35384', )([Res63255,in0Con35384])
Add49090 = keras.layers.Add(name = 'Add49090', )([in0Add49090,in1Add49090])
Res63971 = keras.layers.Reshape((1, 2, 1), name = 'Res63971', )(Add49090)
Res826 = keras.layers.Reshape((1, 2, 1, 1), name = 'Res826', )(Res63971)
Cro21344 = keras.layers.Cropping3D(cropping=((0, 0), (0, 1), (0, 0)), name = 'Cro21344', )(Res826)
Res33974 = keras.layers.Reshape((1, 1, 1), name = 'Res33974', )(Cro21344)
Res75821 = keras.layers.Reshape((1, 1), name = 'Res75821', )(Res33974)
Dot43384 = keras.layers.Dot(axes=(1, 1), name = 'Dot43384', )([Con35384,Res75821])
Ave43544 = keras.layers.AveragePooling1D(pool_size=(1), name = 'Ave43544', )(Dot43384)
model = tf.keras.models.Model(inputs=[in0Con85187,in0Con35384,in0Add49090,in1Add49090], outputs=Ave43544)
w = model.get_layer('Con85187').get_weights() 
w[0] = np.array([[[[[0.6933, 0.5093, 0.4108, 0.5461]], [[0.6384, 0.7574, 0.1362, 0.4829]]]], [[[[0.4613, 0.9174, 0.915, 0.5]], [[0.0749, 0.3804, 0.6258, 0.1062]]]]])
w[1] = np.array([0, 0, 0, 0])
model.get_layer('Con85187').set_weights(w) 
w = model.get_layer('Sep62510').get_weights() 
w[0] = np.array([[[[0.0638], [0.4552], [0.6051], [0.7997]]]])
w[1] = np.array([[[[0.2224, 0.3728], [0.2039, 0.0937], [0.9231, 0.9784], [0.796, 0.5036]]]])
w[2] = np.array([0, 0])
model.get_layer('Sep62510').set_weights(w) 
in0Con85187 = tf.constant([[[[[0.6377], [0.7973]], [[0.7067], [0.8778]]], [[[0.9496], [0.4551]], [[0.5335], [0.371]]]]])
in0Con35384 = tf.constant([[[0.8081, 0.553, 0.3258]]])
in0Add49090 = tf.constant([[[0.1427, 0.621]]])
in1Add49090 = tf.constant([[[0.4676, 0.2178]]])
print (np.array2string(model.predict([in0Con85187,in0Con35384,in0Add49090,in1Add49090],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Ave43544.png')

LCon85187 = conv3D_layer([[[[[0.6377], [0.7973]], [[0.7067], [0.8778]]], [[[0.9496], [0.4551]], [[0.5335], [0.371]]]]], 2, 1, 2,[[[[[0.6933, 0.5093, 0.4108, 0.5461]], [[0.6384, 0.7574, 0.1362, 0.4829]]]], [[[[0.4613, 0.9174, 0.915, 0.5]], [[0.0749, 0.3804, 0.6258, 0.1062]]]]],[0, 0, 0, 0], 1, 1, 1, false, 1, 1, 1, Con85187), 
LRes18262 = reshape_layer(Con85187, [1, 2, 4], Res18262), 
LSep62510 = separable_conv2D_layer(Res18262, 1, 1,[[[[[0.0638], [0.4552], [0.6051], [0.7997]]]],[[[[0.2224, 0.3728], [0.2039, 0.0937], [0.9231, 0.9784], [0.796, 0.5036]]]]],[0, 0], 1, 1, false, Sep62510), 
LRes63255 = reshape_layer(Sep62510, [1, 4], Res63255), 
LCon35384 = concatenate_layer([Res63255,[[[0.8081, 0.553, 0.3258]]]], 2, Con35384), 
LAdd49090 = add_layer([[[[0.1427, 0.621]]], [[[0.4676, 0.2178]]]], Add49090), 
LRes63971 = reshape_layer(Add49090, [1, 2, 1], Res63971), 
LRes826 = reshape_layer(Res63971, [1, 2, 1, 1], Res826), 
LCro21344 = cropping3D_layer(Res826, 0, 0, 0, 1, 0, 0, Cro21344), 
LRes33974 = reshape_layer(Cro21344, [1, 1, 1], Res33974), 
LRes75821 = reshape_layer(Res33974, [1, 1], Res75821), 
LDot43384 = dot_layer(Con35384,Res75821, 1, 1, Dot43384), 
LAve43544 = average_pooling1D_layer(Dot43384, 1, Ave43544), 
exec_layers([LCon85187,LRes18262,LSep62510,LRes63255,LCon35384,LAdd49090,LRes63971,LRes826,LCro21344,LRes33974,LRes75821,LDot43384,LAve43544],["Con85187","Res18262","Sep62510","Res63255","Con35384","Add49090","Res63971","Res826","Cro21344","Res33974","Res75821","Dot43384","Ave43544"],Ave43544,"Ave43544")

Actual (Unparsed): [[[1.1317894], [0.9315541], [0.9240561], [0.7449571], [0.4931834], [0.3374959], [0.1988357]]]

Expected (Unparsed): [[[1.1317894644516826],[0.9315541104632464],[0.9240560722462765],[0.7449570758506994],[0.4931834300000001],[0.33749590000000007],[0.19883574]]]

Actual:   [[[1.1318], [0.9316], [0.9241], [0.745], [0.4932], [0.3375], [0.1989]]]

Expected: [[[1.1318], [0.9316], [0.9241], [0.745], [0.4932], [0.3375], [0.1989]]]