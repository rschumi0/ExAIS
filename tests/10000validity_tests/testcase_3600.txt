import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0Min86112 = tf.keras.layers.Input(shape=([2, 2, 2, 2]))
in1Min86112 = tf.keras.layers.Input(shape=([2, 2, 2, 2]))
in0Ave37090 = tf.keras.layers.Input(shape=([2, 1, 2]))
in0Con63571 = tf.keras.layers.Input(shape=([3, 3, 2]))

Min86112 = keras.layers.Minimum(name = 'Min86112', )([in0Min86112,in1Min86112])
Res20239 = keras.layers.Reshape((2, 2, 4), name = 'Res20239', )(Min86112)
Zer65801 = keras.layers.ZeroPadding2D(padding=((1, 0), (1, 0)), name = 'Zer65801', )(Res20239)
Ave37090 = keras.layers.AveragePooling2D(pool_size=(2, 1), name = 'Ave37090', )(in0Ave37090)
Zer35551 = keras.layers.ZeroPadding2D(padding=((1, 1), (1, 1)), name = 'Zer35551', )(Ave37090)
Con63571 = keras.layers.Concatenate(axis=3, name = 'Con63571', )([Zer35551,in0Con63571])
Ave36728 = keras.layers.Average(name = 'Ave36728', )([Zer65801,Con63571])
Res68025 = keras.layers.Reshape((3, 12), name = 'Res68025', )(Ave36728)
Glo25493 = keras.layers.GlobalAveragePooling1D(name = 'Glo25493', )(Res68025)
Res23394 = keras.layers.Reshape((12, 1), name = 'Res23394', )(Glo25493)
LST65050 = keras.layers.LSTM(1,recurrent_activation='sigmoid', name = 'LST65050', )(Res23394)
model = tf.keras.models.Model(inputs=[in0Min86112,in1Min86112,in0Ave37090,in0Con63571], outputs=LST65050)
w = model.get_layer('LST65050').get_weights() 
w[0] = np.array([[4, 7, 7, 8]])
w[1] = np.array([[4, 10, 5, 9]])
w[2] = np.array([5, 1, 5, 1])
model.get_layer('LST65050').set_weights(w) 
in0Min86112 = tf.constant([[[[[0.12, 0.475], [0.1324, 0.6212]], [[0.1585, 0.8346], [0.7475, 0.3227]]], [[[0.3362, 0.8279], [0.48, 0.5885]], [[0.4821, 0.1174], [0.9152, 0.7359]]]]])
in1Min86112 = tf.constant([[[[[0.5762, 0.2607], [0.4566, 0.1504]], [[0.8857, 0.9871], [0.0485, 0.6035]]], [[[0.1587, 0.9727], [0.1502, 0.1362]], [[0.4298, 0.7383], [0.0139, 0.9334]]]]])
in0Ave37090 = tf.constant([[[[1.8765, 1.5948]], [[1.098, 1.4289]]]])
in0Con63571 = tf.constant([[[[0.6138, 0.6931], [0.5315, 0.1013], [0.1269, 0.9322]], [[0.457, 0.9536], [0.8349, 0.1199], [0.6657, 0.0622]], [[0.9403, 0.6305], [0.2954, 0.3759], [0.2951, 0.3676]]]])
print (np.array2string(model.predict([in0Min86112,in1Min86112,in0Ave37090,in0Con63571],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='LST65050.png')

LMin86112 = minimum_layer([[[[[[0.12, 0.475], [0.1324, 0.6212]], [[0.1585, 0.8346], [0.7475, 0.3227]]], [[[0.3362, 0.8279], [0.48, 0.5885]], [[0.4821, 0.1174], [0.9152, 0.7359]]]]], [[[[[0.5762, 0.2607], [0.4566, 0.1504]], [[0.8857, 0.9871], [0.0485, 0.6035]]], [[[0.1587, 0.9727], [0.1502, 0.1362]], [[0.4298, 0.7383], [0.0139, 0.9334]]]]]], Min86112), 
LRes20239 = reshape_layer(Min86112, [2, 2, 4], Res20239), 
LZer65801 = zero_padding2D_layer(Res20239, 1, 0, 1, 0, Zer65801), 
LAve37090 = average_pooling2D_layer([[[[1.8765, 1.5948]], [[1.098, 1.4289]]]], 2, 1, Ave37090), 
LZer35551 = zero_padding2D_layer(Ave37090, 1, 1, 1, 1, Zer35551), 
LCon63571 = concatenate_layer([Zer35551,[[[[0.6138, 0.6931], [0.5315, 0.1013], [0.1269, 0.9322]], [[0.457, 0.9536], [0.8349, 0.1199], [0.6657, 0.0622]], [[0.9403, 0.6305], [0.2954, 0.3759], [0.2951, 0.3676]]]]], 3, Con63571), 
LAve36728 = average_layer([Zer65801,Con63571], Ave36728), 
LRes68025 = reshape_layer(Ave36728, [3, 12], Res68025), 
LGlo25493 = global_average_pooling1D_layer(Res68025, Glo25493), 
LRes23394 = reshape_layer(Glo25493, [12, 1], Res23394), 
LLST65050 = lstm_layer(Res23394,[[4, 7, 7, 8]],[[4, 10, 5, 9]],[5, 1, 5, 1], LST65050), 
exec_layers([LMin86112,LRes20239,LZer65801,LAve37090,LZer35551,LCon63571,LAve36728,LRes68025,LGlo25493,LRes23394,LLST65050],["Min86112","Res20239","Zer65801","Ave37090","Zer35551","Con63571","Ave36728","Res68025","Glo25493","Res23394","LST65050"],LST65050,"LST65050")

Actual (Unparsed): [[0.9999982]]

Expected (Unparsed): [[0.9999981993044227]]

Actual:   [[1]]

Expected: [[1]]