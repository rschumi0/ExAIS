import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0LST35099 = tf.keras.layers.Input(shape=([1, 1]))
in0Con61848 = tf.keras.layers.Input(shape=([2, 3, 1]))
in0Sof70234 = tf.keras.layers.Input(shape=([1, 2, 2]))

LST35099 = keras.layers.LSTM(3,recurrent_activation='sigmoid', name = 'LST35099', )(in0LST35099)
Res28767 = keras.layers.Reshape((3, 1), name = 'Res28767', )(LST35099)
Loc5452 = keras.layers.LocallyConnected1D(3, (2),strides=(1), name = 'Loc5452', )(Res28767)
Res18481 = keras.layers.Reshape((2, 3, 1), name = 'Res18481', )(Loc5452)
Con61848 = keras.layers.Concatenate(axis=3, name = 'Con61848', )([Res18481,in0Con61848])
Sof70234 = keras.layers.Softmax(axis=1, name = 'Sof70234', input_shape=(1, 2, 2))(in0Sof70234)
Zer85556 = keras.layers.ZeroPadding2D(padding=((1, 0), (1, 0)), name = 'Zer85556', )(Sof70234)
Ave35246 = keras.layers.Average(name = 'Ave35246', )([Con61848,Zer85556])
Res9167 = keras.layers.Reshape((2, 6), name = 'Res9167', )(Ave35246)
Mas88901 = keras.layers.Masking(mask_value=2, name = 'Mas88901', )(Res9167)
model = tf.keras.models.Model(inputs=[in0LST35099,in0Con61848,in0Sof70234], outputs=Mas88901)
w = model.get_layer('LST35099').get_weights() 
w[0] = np.array([[2, 1, 5, 5, 1, 1, 7, 8, 4, 9, 3, 2]])
w[1] = np.array([[1, 8, 4, 7, 9, 2, 4, 5, 7, 4, 3, 4], [8, 5, 5, 6, 6, 2, 1, 5, 7, 4, 2, 9], [2, 2, 8, 6, 1, 6, 8, 9, 10, 10, 8, 2]])
w[2] = np.array([4, 1, 5, 6, 7, 1, 9, 9, 3, 2, 4, 6])
model.get_layer('LST35099').set_weights(w) 
w = model.get_layer('Loc5452').get_weights() 
w[0] = np.array([[[0.5718, 0.3734, 0.0636], [0.6429, 0.2572, 0.0414]], [[0.1035, 0.8783, 0.2739], [0.3856, 0.0178, 0.6714]]])
w[1] = np.array([[0, 0, 0], [0, 0, 0]])
model.get_layer('Loc5452').set_weights(w) 
in0LST35099 = tf.constant([[[4]]])
in0Con61848 = tf.constant([[[[0.1872], [0.1396], [0.8178]], [[0.5166], [0.6328], [0.81]]]])
in0Sof70234 = tf.constant([[[[0.2235, 0.9178], [0.1537, 0.6996]]]])
print (np.array2string(model.predict([in0LST35099,in0Con61848,in0Sof70234],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Mas88901.png')

LLST35099 = lstm_layer([[[4]]],[[2, 1, 5, 5, 1, 1, 7, 8, 4, 9, 3, 2]],[[1, 8, 4, 7, 9, 2, 4, 5, 7, 4, 3, 4], [8, 5, 5, 6, 6, 2, 1, 5, 7, 4, 2, 9], [2, 2, 8, 6, 1, 6, 8, 9, 10, 10, 8, 2]],[4, 1, 5, 6, 7, 1, 9, 9, 3, 2, 4, 6], LST35099), 
LRes28767 = reshape_layer(LST35099, [3, 1], Res28767), 
LLoc5452 = locally_connected1D_layer(Res28767, 2,[[[0.5718, 0.3734, 0.0636], [0.6429, 0.2572, 0.0414]], [[0.1035, 0.8783, 0.2739], [0.3856, 0.0178, 0.6714]]],[[0, 0, 0], [0, 0, 0]], 1, Loc5452), 
LRes18481 = reshape_layer(Loc5452, [2, 3, 1], Res18481), 
LCon61848 = concatenate_layer([Res18481,[[[[0.1872], [0.1396], [0.8178]], [[0.5166], [0.6328], [0.81]]]]], 3, Con61848), 
LSof70234 = softmax_layer([[[[0.2235, 0.9178], [0.1537, 0.6996]]]], 1, Sof70234), 
LZer85556 = zero_padding2D_layer(Sof70234, 1, 0, 1, 0, Zer85556), 
LAve35246 = average_layer([Con61848,Zer85556], Ave35246), 
LRes9167 = reshape_layer(Ave35246, [2, 6], Res9167), 
LMas88901 = masking_layer(Res9167, 2, Mas88901), 
exec_layers([LLST35099,LRes28767,LLoc5452,LRes18481,LCon61848,LSof70234,LZer85556,LAve35246,LRes9167,LMas88901],["LST35099","Res28767","Loc5452","Res18481","Con61848","Sof70234","Zer85556","Ave35246","Res9167","Mas88901"],Mas88901,"Mas88901")

Actual (Unparsed): [[[0.4616453, 0.0936000, 0.2397668, 0.0698000, 0.0399251, 0.4089000], [0.1861015, 0.2583000, 0.8399915, 0.8164000, 0.8595803, 0.9050000]]]

Expected (Unparsed): [[[0.4616452900018848,0.0936,0.23976682595362597,0.0698,0.03992512805215781,0.4089],[0.18610152104376315,0.2583,0.8399915388408049,0.8164,0.8595803445587422,0.905]]]

Actual:   [[[0.4617, 0.0936, 0.2398, 0.0698, 0.04, 0.4089], [0.1862, 0.2583, 0.84, 0.8164, 0.8596, 0.905]]]

Expected: [[[0.4617, 0.0936, 0.2398, 0.0698, 0.04, 0.4089], [0.1862, 0.2583, 0.84, 0.8164, 0.8596, 0.905]]]