import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0Dot4022 = tf.keras.layers.Input(shape=([3, 3]))
in1Dot4022 = tf.keras.layers.Input(shape=([3, 3]))
in0Min36298 = tf.keras.layers.Input(shape=([2, 1, 1, 1]))
in1Min36298 = tf.keras.layers.Input(shape=([2, 1, 1, 1]))
in0Con54759 = tf.keras.layers.Input(shape=([1]))
in0Con34646 = tf.keras.layers.Input(shape=([2, 1, 1]))
in0Con12123 = tf.keras.layers.Input(shape=([8]))

Dot4022 = keras.layers.Dot(axes=(2, 1), name = 'Dot4022', )([in0Dot4022,in1Dot4022])
Fla67726 = keras.layers.Flatten(name = 'Fla67726', )(Dot4022)
Min36298 = keras.layers.Minimum(name = 'Min36298', )([in0Min36298,in1Min36298])
Res31002 = keras.layers.Reshape((2, 1, 1), name = 'Res31002', )(Min36298)
Res8685 = keras.layers.Reshape((2, 1), name = 'Res8685', )(Res31002)
Fla54219 = keras.layers.Flatten(name = 'Fla54219', )(Res8685)
Con54759 = keras.layers.Concatenate(axis=1, name = 'Con54759', )([Fla54219,in0Con54759])
Con34646 = keras.layers.Conv2D(4, (1, 1),strides=(4, 1), padding='same', dilation_rate=(1, 1), name = 'Con34646', )(in0Con34646)
Res53893 = keras.layers.Reshape((1, 4), name = 'Res53893', )(Con34646)
Sim98753 = keras.layers.SimpleRNN(3,name = 'Sim98753', )(Res53893)
Ave43557 = keras.layers.Average(name = 'Ave43557', )([Con54759,Sim98753])
Res77432 = keras.layers.Reshape((3, 1), name = 'Res77432', )(Ave43557)
Sim84656 = keras.layers.SimpleRNN(1,name = 'Sim84656', )(Res77432)
Res611 = keras.layers.Reshape((1, 1), name = 'Res611', )(Sim84656)
Glo8366 = keras.layers.GlobalAveragePooling1D(name = 'Glo8366', )(Res611)
Con12123 = keras.layers.Concatenate(axis=1, name = 'Con12123', )([Glo8366,in0Con12123])
Ave86873 = keras.layers.Average(name = 'Ave86873', )([Fla67726,Con12123])
model = tf.keras.models.Model(inputs=[in0Dot4022,in1Dot4022,in0Min36298,in1Min36298,in0Con54759,in0Con34646,in0Con12123], outputs=Ave86873)
w = model.get_layer('Con34646').get_weights() 
w[0] = np.array([[[[0.9638, 0.8134, 0.3317, 0.0715]]]])
w[1] = np.array([0, 0, 0, 0])
model.get_layer('Con34646').set_weights(w) 
w = model.get_layer('Sim98753').get_weights() 
w[0] = np.array([[8, 9, 4], [9, 1, 6], [4, 1, 5], [2, 5, 5]])
w[1] = np.array([[2, 5, 1], [10, 8, 1], [2, 2, 5]])
w[2] = np.array([8, 6, 1])
model.get_layer('Sim98753').set_weights(w) 
w = model.get_layer('Sim84656').get_weights() 
w[0] = np.array([[4]])
w[1] = np.array([[3]])
w[2] = np.array([8])
model.get_layer('Sim84656').set_weights(w) 
in0Dot4022 = tf.constant([[[0.3344, 0.2682, 0.6702], [0.6893, 0.8477, 0.3043], [0.4616, 0.8316, 0.323]]])
in1Dot4022 = tf.constant([[[0.0078, 0.4815, 0.5219], [0.2618, 0.4763, 0.6657], [0.6671, 0.9849, 0.9731]]])
in0Min36298 = tf.constant([[[[[0.8136]]], [[[0.1042]]]]])
in1Min36298 = tf.constant([[[[[0.1868]]], [[[0.5957]]]]])
in0Con54759 = tf.constant([[0.5455]])
in0Con34646 = tf.constant([[[[0.9157]], [[0.8319]]]])
in0Con12123 = tf.constant([[0.9852, 0.5129, 0.5998, 0.8276, 0.4689, 0.0848, 0.6888, 0.645]])
print (np.array2string(model.predict([in0Dot4022,in1Dot4022,in0Min36298,in1Min36298,in0Con54759,in0Con34646,in0Con12123],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Ave86873.png')

LDot4022 = dot_layer([[[0.3344, 0.2682, 0.6702], [0.6893, 0.8477, 0.3043], [0.4616, 0.8316, 0.323]]], [[[0.0078, 0.4815, 0.5219], [0.2618, 0.4763, 0.6657], [0.6671, 0.9849, 0.9731]]], 2, 1, Dot4022), 
LFla67726 = flatten_layer(Dot4022, Fla67726), 
LMin36298 = minimum_layer([[[[[[0.8136]]], [[[0.1042]]]]], [[[[[0.1868]]], [[[0.5957]]]]]], Min36298), 
LRes31002 = reshape_layer(Min36298, [2, 1, 1], Res31002), 
LRes8685 = reshape_layer(Res31002, [2, 1], Res8685), 
LFla54219 = flatten_layer(Res8685, Fla54219), 
LCon54759 = concatenate_layer([Fla54219,[[0.5455]]], 1, Con54759), 
LCon34646 = conv2D_layer([[[[0.9157]], [[0.8319]]]], 1, 1,[[[[0.9638, 0.8134, 0.3317, 0.0715]]]],[0, 0, 0, 0], 4, 1, true, 1, 1, Con34646), 
LRes53893 = reshape_layer(Con34646, [1, 4], Res53893), 
LSim98753 = simple_rnn_layer(Res53893,[[8, 9, 4], [9, 1, 6], [4, 1, 5], [2, 5, 5]],[[2, 5, 1], [10, 8, 1], [2, 2, 5]],[8, 6, 1], Sim98753), 
LAve43557 = average_layer([Con54759,Sim98753], Ave43557), 
LRes77432 = reshape_layer(Ave43557, [3, 1], Res77432), 
LSim84656 = simple_rnn_layer(Res77432,[[4]],[[3]],[8], Sim84656), 
LRes611 = reshape_layer(Sim84656, [1, 1], Res611), 
LGlo8366 = global_average_pooling1D_layer(Res611, Glo8366), 
LCon12123 = concatenate_layer([Glo8366,[[0.9852, 0.5129, 0.5998, 0.8276, 0.4689, 0.0848, 0.6888, 0.645]]], 1, Con12123), 
LAve86873 = average_layer([Fla67726,Con12123], Ave86873), 
exec_layers([LDot4022,LFla67726,LMin36298,LRes31002,LRes8685,LFla54219,LCon54759,LCon34646,LRes53893,LSim98753,LAve43557,LRes77432,LSim84656,LRes611,LGlo8366,LCon12123,LAve86873],["Dot4022","Fla67726","Min36298","Res31002","Res8685","Fla54219","Con54759","Con34646","Res53893","Sim98753","Ave43557","Res77432","Sim84656","Res611","Glo8366","Con12123","Ave86873"],Ave86873,"Ave86873")

Actual (Unparsed): [[0.7599568, 0.9670186, 0.7590679, 0.5150515, 0.9314813, 0.8445370, 0.2607933, 0.8126371, 0.8769082]]

Expected (Unparsed): [[0.7599567499994236,0.9670186199999999,0.75906786,0.515051465,0.931481265,0.844536945,0.26079333,0.81263709,0.87690823]]

Actual:   [[0.76, 0.9671, 0.7591, 0.5151, 0.9315, 0.8446, 0.2608, 0.8127, 0.877]]

Expected: [[0.76, 0.9671, 0.7591, 0.5151, 0.9315, 0.8446, 0.2608, 0.8127, 0.877]]