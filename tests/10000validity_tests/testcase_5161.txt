import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0Mul20223 = tf.keras.layers.Input(shape=([2, 2, 1, 2]))
in1Mul20223 = tf.keras.layers.Input(shape=([2, 2, 1, 2]))
in0LST69605 = tf.keras.layers.Input(shape=([3, 3]))
in0Con46912 = tf.keras.layers.Input(shape=([15]))

Mul20223 = keras.layers.Multiply(name = 'Mul20223', )([in0Mul20223,in1Mul20223])
Up_82353 = keras.layers.UpSampling3D(size=(2, 1, 1), name = 'Up_82353', )(Mul20223)
Res80825 = keras.layers.Reshape((4, 2, 2), name = 'Res80825', )(Up_82353)
Res56562 = keras.layers.Reshape((4, 4), name = 'Res56562', )(Res80825)
Fla73568 = keras.layers.Flatten(name = 'Fla73568', )(Res56562)
LST69605 = keras.layers.LSTM(1,recurrent_activation='sigmoid', name = 'LST69605', )(in0LST69605)
Con46912 = keras.layers.Concatenate(axis=1, name = 'Con46912', )([LST69605,in0Con46912])
Ave95752 = keras.layers.Average(name = 'Ave95752', )([Fla73568,Con46912])
model = tf.keras.models.Model(inputs=[in0Mul20223,in1Mul20223,in0LST69605,in0Con46912], outputs=Ave95752)
w = model.get_layer('LST69605').get_weights() 
w[0] = np.array([[1, 5, 9, 2], [6, 1, 9, 6], [7, 8, 9, 7]])
w[1] = np.array([[3, 6, 8, 7]])
w[2] = np.array([4, 10, 9, 10])
model.get_layer('LST69605').set_weights(w) 
in0Mul20223 = tf.constant([[[[[0.9775, 0.3925]], [[0.4577, 0.9377]]], [[[0.7512, 0.9184]], [[0.8095, 0.6253]]]]])
in1Mul20223 = tf.constant([[[[[0.6283, 0.8867]], [[0.6916, 0.8639]]], [[[0.7162, 0.8678]], [[0.3108, 0.7151]]]]])
in0LST69605 = tf.constant([[[10, 1, 7], [10, 10, 6], [10, 4, 7]]])
in0Con46912 = tf.constant([[0.855, 0.6569, 0.9586, 0.5237, 0.8862, 0.1967, 0.7411, 0.5286, 0.7152, 0.5814, 0.1838, 0.4084, 0.6066, 0.2627, 0.3169]])
print (np.array2string(model.predict([in0Mul20223,in1Mul20223,in0LST69605,in0Con46912],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Ave95752.png')

LMul20223 = multiply_layer([[[[[[0.9775, 0.3925]], [[0.4577, 0.9377]]], [[[0.7512, 0.9184]], [[0.8095, 0.6253]]]]], [[[[[0.6283, 0.8867]], [[0.6916, 0.8639]]], [[[0.7162, 0.8678]], [[0.3108, 0.7151]]]]]], Mul20223), 
LUp_82353 = up_sampling3D_layer(Mul20223, 2, 1, 1, Up_82353), 
LRes80825 = reshape_layer(Up_82353, [4, 2, 2], Res80825), 
LRes56562 = reshape_layer(Res80825, [4, 4], Res56562), 
LFla73568 = flatten_layer(Res56562, Fla73568), 
LLST69605 = lstm_layer([[[10, 1, 7], [10, 10, 6], [10, 4, 7]]],[[1, 5, 9, 2], [6, 1, 9, 6], [7, 8, 9, 7]],[[3, 6, 8, 7]],[4, 10, 9, 10], LST69605), 
LCon46912 = concatenate_layer([LST69605,[[0.855, 0.6569, 0.9586, 0.5237, 0.8862, 0.1967, 0.7411, 0.5286, 0.7152, 0.5814, 0.1838, 0.4084, 0.6066, 0.2627, 0.3169]]], 1, Con46912), 
LAve95752 = average_layer([Fla73568,Con46912], Ave95752), 
exec_layers([LMul20223,LUp_82353,LRes80825,LRes56562,LFla73568,LLST69605,LCon46912,LAve95752],["Mul20223","Up_82353","Res80825","Res56562","Fla73568","LST69605","Con46912","Ave95752"],Ave95752,"Ave95752")

Actual (Unparsed): [[0.8046090, 0.6015149, 0.4867227, 0.8843395, 0.5689316, 0.6171149, 0.2566227, 0.7755895, 0.5333047, 0.7560938, 0.4164963, 0.3154760, 0.4732047, 0.7017937, 0.2571463, 0.3820260]]

Expected (Unparsed): [[0.8046090018433651,0.601514875,0.48672266000000003,0.884339515,0.568931625,0.617114875,0.25662266,0.7755895150000001,0.53330472,0.75609376,0.41649630000000004,0.31547601499999994,0.47320471999999997,0.70179376,0.2571463,0.382026015]]

Actual:   [[0.8047, 0.6016, 0.4868, 0.8844, 0.569, 0.6172, 0.2567, 0.7756, 0.5334, 0.7561, 0.4165, 0.3155, 0.4733, 0.7018, 0.2572, 0.3821]]

Expected: [[0.8047, 0.6016, 0.4868, 0.8844, 0.569, 0.6172, 0.2567, 0.7756, 0.5334, 0.7561, 0.4165, 0.3155, 0.4733, 0.7018, 0.2572, 0.3821]]