import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0Add43224 = tf.keras.layers.Input(shape=([1, 1, 1, 1]))
in1Add43224 = tf.keras.layers.Input(shape=([1, 1, 1, 1]))
in0Sub38005 = tf.keras.layers.Input(shape=([2, 3, 3]))
in1Sub38005 = tf.keras.layers.Input(shape=([2, 3, 3]))

Add43224 = keras.layers.Add(name = 'Add43224', )([in0Add43224,in1Add43224])
Res89705 = keras.layers.Reshape((1, 1, 1), name = 'Res89705', )(Add43224)
Res99273 = keras.layers.Reshape((1, 1), name = 'Res99273', )(Res89705)
GRU32880 = keras.layers.GRU(3,reset_after=False, recurrent_activation='sigmoid', name = 'GRU32880', )(Res99273)
Sub38005 = keras.layers.Subtract(name = 'Sub38005', )([in0Sub38005,in1Sub38005])
Glo77531 = keras.layers.GlobalAveragePooling2D(name = 'Glo77531', )(Sub38005)
Ave43821 = keras.layers.Average(name = 'Ave43821', )([GRU32880,Glo77531])
Mas92616 = keras.layers.Masking(mask_value=2, name = 'Mas92616', )(Ave43821)
model = tf.keras.models.Model(inputs=[in0Add43224,in1Add43224,in0Sub38005,in1Sub38005], outputs=Mas92616)
w = model.get_layer('GRU32880').get_weights() 
w[0] = np.array([[5, 9, 4, 9, 3, 9, 1, 8, 1]])
w[1] = np.array([[3, 2, 1, 3, 3, 5, 9, 4, 8], [3, 10, 7, 9, 9, 4, 7, 4, 9], [10, 10, 6, 4, 6, 10, 9, 3, 4]])
w[2] = np.array([7, 8, 5, 8, 2, 6, 5, 7, 5])
model.get_layer('GRU32880').set_weights(w) 
in0Add43224 = tf.constant([[[[[0.0542]]]]])
in1Add43224 = tf.constant([[[[[0.8054]]]]])
in0Sub38005 = tf.constant([[[[0.2548, 0.0166, 0.0171], [0.5302, 0.5299, 0.4682], [0.6308, 0.6196, 0.1307]], [[0.9167, 0.4976, 0.1708], [0.5138, 0.9002, 0.3407], [0.8036, 0.4643, 0.1379]]]])
in1Sub38005 = tf.constant([[[[0.7166, 0.5447, 0.5001], [0.5276, 0.3608, 0.0552], [0.5882, 0.6122, 0.8492]], [[0.3377, 0.3357, 0.7844], [0.1874, 0.8685, 0.3168], [0.0163, 0.2723, 0.5649]]]])
print (np.array2string(model.predict([in0Add43224,in1Add43224,in0Sub38005,in1Sub38005],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Mas92616.png')

LAdd43224 = add_layer([[[[[[0.0542]]]]], [[[[[0.8054]]]]]], Add43224), 
LRes89705 = reshape_layer(Add43224, [1, 1, 1], Res89705), 
LRes99273 = reshape_layer(Res89705, [1, 1], Res99273), 
LGRU32880 = gru_layer(Res99273,[[5, 9, 4, 9, 3, 9, 1, 8, 1]],[[3, 2, 1, 3, 3, 5, 9, 4, 8], [3, 10, 7, 9, 9, 4, 7, 4, 9], [10, 10, 6, 4, 6, 10, 9, 3, 4]],[7, 8, 5, 8, 2, 6, 5, 7, 5], false, GRU32880), 
LSub38005 = subtract_layer([[[[0.2548, 0.0166, 0.0171], [0.5302, 0.5299, 0.4682], [0.6308, 0.6196, 0.1307]], [[0.9167, 0.4976, 0.1708], [0.5138, 0.9002, 0.3407], [0.8036, 0.4643, 0.1379]]]], [[[[0.7166, 0.5447, 0.5001], [0.5276, 0.3608, 0.0552], [0.5882, 0.6122, 0.8492]], [[0.3377, 0.3357, 0.7844], [0.1874, 0.8685, 0.3168], [0.0163, 0.2723, 0.5649]]]], Sub38005), 
LGlo77531 = global_average_pooling2D_layer(Sub38005, Glo77531), 
LAve43821 = average_layer([GRU32880,Glo77531], Ave43821), 
LMas92616 = masking_layer(Ave43821, 2, Mas92616), 
exec_layers([LAdd43224,LRes89705,LRes99273,LGRU32880,LSub38005,LGlo77531,LAve43821,LMas92616],["Add43224","Res89705","Res99273","GRU32880","Sub38005","Glo77531","Ave43821","Mas92616"],Mas92616,"Mas92616")

Actual (Unparsed): [[0.1063479, 0.0028334, -0.1503252]]

Expected (Unparsed): [[0.10634786533638578,0.0028334065716334824,-0.15032516044852298]]

Actual:   [[0.1064, 0.0029, -0.1503]]

Expected: [[0.1064, 0.0029, -0.1503]]