import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0LST8367 = tf.keras.layers.Input(shape=([2, 2]))
in0Add32947 = tf.keras.layers.Input(shape=([2, 2, 1, 1]))
in1Add32947 = tf.keras.layers.Input(shape=([2, 2, 1, 1]))

LST8367 = keras.layers.LSTM(3,recurrent_activation='sigmoid', name = 'LST8367', )(in0LST8367)
Res52780 = keras.layers.Reshape((3, 1), name = 'Res52780', )(LST8367)
Res74337 = keras.layers.Reshape((3, 1, 1), name = 'Res74337', )(Res52780)
Res82633 = keras.layers.Reshape((3, 1, 1, 1), name = 'Res82633', )(Res74337)
Zer10853 = keras.layers.ZeroPadding3D(padding=((0, 0), (2, 0), (0, 0)), name = 'Zer10853', )(Res82633)
Add32947 = keras.layers.Add(name = 'Add32947', )([in0Add32947,in1Add32947])
Zer91784 = keras.layers.ZeroPadding3D(padding=((1, 0), (1, 0), (0, 0)), name = 'Zer91784', )(Add32947)
Add77270 = keras.layers.Add(name = 'Add77270', )([Zer10853,Zer91784])
Res44943 = keras.layers.Reshape((3, 3, 1), name = 'Res44943', )(Add77270)
Res2574 = keras.layers.Reshape((3, 3), name = 'Res2574', )(Res44943)
Per65871 = keras.layers.Permute((1,2), name = 'Per65871',)(Res2574)
Lay61425 = keras.layers.LayerNormalization(axis=1, epsilon=1.969156806391353, name = 'Lay61425', )(Per65871)
model = tf.keras.models.Model(inputs=[in0LST8367,in0Add32947,in1Add32947], outputs=Lay61425)
w = model.get_layer('LST8367').get_weights() 
w[0] = np.array([[6, 4, 7, 6, 1, 5, 4, 10, 7, 6, 10, 8], [10, 2, 1, 1, 4, 9, 4, 2, 8, 2, 1, 1]])
w[1] = np.array([[3, 2, 6, 2, 5, 10, 4, 7, 2, 5, 7, 3], [2, 6, 9, 1, 10, 5, 9, 8, 10, 1, 7, 4], [2, 10, 4, 2, 3, 8, 3, 9, 4, 9, 4, 2]])
w[2] = np.array([8, 3, 8, 9, 1, 7, 8, 5, 5, 4, 9, 4])
model.get_layer('LST8367').set_weights(w) 
in0LST8367 = tf.constant([[[1, 2], [6, 7]]])
in0Add32947 = tf.constant([[[[[0.4796]], [[0.3375]]], [[[0.8299]], [[0.1682]]]]])
in1Add32947 = tf.constant([[[[[0.4637]], [[0.8673]]], [[[0.7078]], [[0.6108]]]]])
print (np.array2string(model.predict([in0LST8367,in0Add32947,in1Add32947],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Lay61425.png')

LLST8367 = lstm_layer([[[1, 2], [6, 7]]],[[6, 4, 7, 6, 1, 5, 4, 10, 7, 6, 10, 8], [10, 2, 1, 1, 4, 9, 4, 2, 8, 2, 1, 1]],[[3, 2, 6, 2, 5, 10, 4, 7, 2, 5, 7, 3], [2, 6, 9, 1, 10, 5, 9, 8, 10, 1, 7, 4], [2, 10, 4, 2, 3, 8, 3, 9, 4, 9, 4, 2]],[8, 3, 8, 9, 1, 7, 8, 5, 5, 4, 9, 4], LST8367), 
LRes52780 = reshape_layer(LST8367, [3, 1], Res52780), 
LRes74337 = reshape_layer(Res52780, [3, 1, 1], Res74337), 
LRes82633 = reshape_layer(Res74337, [3, 1, 1, 1], Res82633), 
LZer10853 = zero_padding3D_layer(Res82633, 0, 0, 2, 0, 0, 0, Zer10853), 
LAdd32947 = add_layer([[[[[[0.4796]], [[0.3375]]], [[[0.8299]], [[0.1682]]]]], [[[[[0.4637]], [[0.8673]]], [[[0.7078]], [[0.6108]]]]]], Add32947), 
LZer91784 = zero_padding3D_layer(Add32947, 1, 0, 1, 0, 0, 0, Zer91784), 
LAdd77270 = add_layer([Zer10853,Zer91784], Add77270), 
LRes44943 = reshape_layer(Add77270, [3, 3, 1], Res44943), 
LRes2574 = reshape_layer(Res44943, [3, 3], Res2574), 
LPer65871 = permute_layer(Res2574, 1,2, Per65871), 
LLay61425 = layer_normalization_layer(Per65871, 1, 1.969156806391353, Lay61425), 
exec_layers([LLST8367,LRes52780,LRes74337,LRes82633,LZer10853,LAdd32947,LZer91784,LAdd77270,LRes44943,LRes2574,LPer65871,LLay61425],["LST8367","Res52780","Res74337","Res82633","Zer10853","Add32947","Zer91784","Add77270","Res44943","Res2574","Per65871","Lay61425"],Lay61425,"Lay61425")

Actual (Unparsed): [[[0.0000000, -0.5371935, -0.4440118], [0.0000000, 0.0755449, 0.3649587], [0.0000000, 0.4616486, 0.0790531]]]

Expected (Unparsed): [[[0.0,-0.5371934862320146,-0.44401183394063737],[0.0,0.07554486390421201,0.36495870631074917],[0.0,0.4616486223278027,0.07905312762988814]]]

Actual:   [[[0, -0.5371, -0.444], [0, 0.0756, 0.365], [0, 0.4617, 0.0791]]]

Expected: [[[0, -0.5371, -0.444], [0, 0.0756, 0.365], [0, 0.4617, 0.0791]]]