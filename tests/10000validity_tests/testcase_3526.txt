import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0Ave80000 = tf.keras.layers.Input(shape=([2, 2, 2, 2]))
in1Ave80000 = tf.keras.layers.Input(shape=([2, 2, 2, 2]))
in0PRe83887 = tf.keras.layers.Input(shape=([2, 1, 2, 1]))
in0Con31514 = tf.keras.layers.Input(shape=([2, 2, 2, 1]))

Ave80000 = keras.layers.Average(name = 'Ave80000', )([in0Ave80000,in1Ave80000])
PRe83887 = keras.layers.PReLU(name = 'PRe83887', input_shape=(2, 1, 2, 1))(in0PRe83887)
ReL68178 = keras.layers.ReLU(max_value=6.873211197137724, negative_slope=4.282995034753612, threshold=9.992737982720552, name = 'ReL68178', )(PRe83887)
Zer95504 = keras.layers.ZeroPadding3D(padding=((0, 0), (1, 0), (0, 0)), name = 'Zer95504', )(ReL68178)
Con31514 = keras.layers.Concatenate(axis=4, name = 'Con31514', )([Zer95504,in0Con31514])
Min41593 = keras.layers.Minimum(name = 'Min41593', )([Ave80000,Con31514])
Res14576 = keras.layers.Reshape((2, 2, 4), name = 'Res14576', )(Min41593)
Res70554 = keras.layers.Reshape((2, 8), name = 'Res70554', )(Res14576)
Glo30471 = keras.layers.GlobalMaxPool1D(name = 'Glo30471', )(Res70554)
Thr64819 = keras.layers.ThresholdedReLU(theta=6.3141438179563485, name = 'Thr64819', )(Glo30471)
Res29221 = keras.layers.Reshape((8, 1), name = 'Res29221', )(Thr64819)
LST43539 = keras.layers.LSTM(1,recurrent_activation='sigmoid', name = 'LST43539', )(Res29221)
model = tf.keras.models.Model(inputs=[in0Ave80000,in1Ave80000,in0PRe83887,in0Con31514], outputs=LST43539)
w = model.get_layer('PRe83887').get_weights() 
w[0] = np.array([[[[0.4661], [0.1881]]], [[[0.0998], [0.8073]]]])
model.get_layer('PRe83887').set_weights(w) 
w = model.get_layer('LST43539').get_weights() 
w[0] = np.array([[8, 10, 1, 4]])
w[1] = np.array([[8, 5, 4, 6]])
w[2] = np.array([1, 5, 7, 10])
model.get_layer('LST43539').set_weights(w) 
in0Ave80000 = tf.constant([[[[[0.4138, 0.3339], [0.1304, 0.4971]], [[0.0545, 0.7132], [0.4593, 0.8725]]], [[[0.2631, 0.1472], [0.7286, 0.5914]], [[0.3102, 0.6831], [0.7384, 0.7228]]]]])
in1Ave80000 = tf.constant([[[[[0.0509, 0.6168], [0.5914, 0.0662]], [[0.3999, 0.0418], [0.7958, 0.7219]]], [[[0.8736, 0.6987], [0.6303, 0.1904]], [[0.2415, 0.5361], [0.7953, 0.2777]]]]])
in0PRe83887 = tf.constant([[[[[0.4632], [0.3522]]], [[[0.4709], [0.1203]]]]])
in0Con31514 = tf.constant([[[[[0.5746], [0.3378]], [[0.812], [0.3827]]], [[[0.7414], [0.7968]], [[0.9175], [0.818]]]]])
print (np.array2string(model.predict([in0Ave80000,in1Ave80000,in0PRe83887,in0Con31514],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='LST43539.png')

LAve80000 = average_layer([[[[[[0.4138, 0.3339], [0.1304, 0.4971]], [[0.0545, 0.7132], [0.4593, 0.8725]]], [[[0.2631, 0.1472], [0.7286, 0.5914]], [[0.3102, 0.6831], [0.7384, 0.7228]]]]], [[[[[0.0509, 0.6168], [0.5914, 0.0662]], [[0.3999, 0.0418], [0.7958, 0.7219]]], [[[0.8736, 0.6987], [0.6303, 0.1904]], [[0.2415, 0.5361], [0.7953, 0.2777]]]]]], Ave80000), 
LPRe83887 = prelu_layer([[[[[0.4632], [0.3522]]], [[[0.4709], [0.1203]]]]], [[[[0.4661], [0.1881]]], [[[0.0998], [0.8073]]]], PRe83887), 
LReL68178 = relu_layer(PRe83887, 6.873211197137724, 4.282995034753612, 9.992737982720552, ReL68178), 
LZer95504 = zero_padding3D_layer(ReL68178, 0, 0, 1, 0, 0, 0, Zer95504), 
LCon31514 = concatenate_layer([Zer95504,[[[[[0.5746], [0.3378]], [[0.812], [0.3827]]], [[[0.7414], [0.7968]], [[0.9175], [0.818]]]]]], 4, Con31514), 
LMin41593 = minimum_layer([Ave80000,Con31514], Min41593), 
LRes14576 = reshape_layer(Min41593, [2, 2, 4], Res14576), 
LRes70554 = reshape_layer(Res14576, [2, 8], Res70554), 
LGlo30471 = global_max_pool1D_layer(Res70554, Glo30471), 
LThr64819 = thresholded_relu_layer(Glo30471, 6.3141438179563485, Thr64819), 
LRes29221 = reshape_layer(Thr64819, [8, 1], Res29221), 
LLST43539 = lstm_layer(Res29221,[[8, 10, 1, 4]],[[8, 5, 4, 6]],[1, 5, 7, 10], LST43539), 
exec_layers([LAve80000,LPRe83887,LReL68178,LZer95504,LCon31514,LMin41593,LRes14576,LRes70554,LGlo30471,LThr64819,LRes29221,LLST43539],["Ave80000","PRe83887","ReL68178","Zer95504","Con31514","Min41593","Res14576","Res70554","Glo30471","Thr64819","Res29221","LST43539"],LST43539,"LST43539")

Actual (Unparsed): [[0.9999995]]

Expected (Unparsed): [[0.9999994983926153]]

Actual:   [[1]]

Expected: [[1]]