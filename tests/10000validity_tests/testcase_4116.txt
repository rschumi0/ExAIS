import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0Sub93021 = tf.keras.layers.Input(shape=([3, 2, 3]))
in1Sub93021 = tf.keras.layers.Input(shape=([3, 2, 3]))

Sub93021 = keras.layers.Subtract(name = 'Sub93021', )([in0Sub93021,in1Sub93021])
Res82837 = keras.layers.Reshape((3, 6), name = 'Res82837', )(Sub93021)
GRU65604 = keras.layers.GRU(3,reset_after=False, recurrent_activation='sigmoid', name = 'GRU65604', )(Res82837)
Res75107 = keras.layers.Reshape((3, 1), name = 'Res75107', )(GRU65604)
Res50937 = keras.layers.Reshape((3, 1, 1), name = 'Res50937', )(Res75107)
Res20581 = keras.layers.Reshape((3, 1, 1, 1), name = 'Res20581', )(Res50937)
Con87419 = keras.layers.Conv3D(3, (1, 1, 1),strides=(6, 1, 1), padding='valid', dilation_rate=(1, 1, 1), name = 'Con87419', )(Res20581)
model = tf.keras.models.Model(inputs=[in0Sub93021,in1Sub93021], outputs=Con87419)
w = model.get_layer('GRU65604').get_weights() 
w[0] = np.array([[4, 1, 10, 3, 7, 3, 3, 8, 10], [8, 3, 5, 5, 8, 8, 4, 10, 2], [5, 3, 7, 1, 6, 5, 9, 2, 6], [8, 1, 7, 8, 3, 6, 2, 4, 9], [4, 5, 8, 6, 6, 10, 3, 10, 4], [5, 6, 5, 8, 7, 4, 2, 4, 2]])
w[1] = np.array([[3, 1, 4, 6, 4, 6, 6, 1, 2], [2, 5, 5, 7, 8, 1, 8, 1, 10], [2, 4, 8, 5, 1, 10, 3, 5, 9]])
w[2] = np.array([10, 4, 8, 4, 8, 8, 3, 4, 5])
model.get_layer('GRU65604').set_weights(w) 
w = model.get_layer('Con87419').get_weights() 
w[0] = np.array([[[[[0.6036, 0.6969, 0.8339]]]]])
w[1] = np.array([0, 0, 0])
model.get_layer('Con87419').set_weights(w) 
in0Sub93021 = tf.constant([[[[0.4237, 0.3763, 0.1868], [0.2002, 0.6209, 0.3651]], [[0.5764, 0.8407, 0.5012], [0.6136, 0.3963, 0.0141]], [[0.4805, 0.9854, 0.0276], [0.553, 0.2188, 0.7545]]]])
in1Sub93021 = tf.constant([[[[0.0466, 0.1843, 0.8671], [0.1059, 0.1831, 0.9632]], [[0.4845, 0.6272, 0.3184], [0.0466, 0.3176, 0.2195]], [[0.3121, 0.7895, 0.2733], [0.7187, 0.1017, 0.6519]]]])
print (np.array2string(model.predict([in0Sub93021,in1Sub93021],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Con87419.png')

LSub93021 = subtract_layer([[[[0.4237, 0.3763, 0.1868], [0.2002, 0.6209, 0.3651]], [[0.5764, 0.8407, 0.5012], [0.6136, 0.3963, 0.0141]], [[0.4805, 0.9854, 0.0276], [0.553, 0.2188, 0.7545]]]], [[[[0.0466, 0.1843, 0.8671], [0.1059, 0.1831, 0.9632]], [[0.4845, 0.6272, 0.3184], [0.0466, 0.3176, 0.2195]], [[0.3121, 0.7895, 0.2733], [0.7187, 0.1017, 0.6519]]]], Sub93021), 
LRes82837 = reshape_layer(Sub93021, [3, 6], Res82837), 
LGRU65604 = gru_layer(Res82837,[[4, 1, 10, 3, 7, 3, 3, 8, 10], [8, 3, 5, 5, 8, 8, 4, 10, 2], [5, 3, 7, 1, 6, 5, 9, 2, 6], [8, 1, 7, 8, 3, 6, 2, 4, 9], [4, 5, 8, 6, 6, 10, 3, 10, 4], [5, 6, 5, 8, 7, 4, 2, 4, 2]],[[3, 1, 4, 6, 4, 6, 6, 1, 2], [2, 5, 5, 7, 8, 1, 8, 1, 10], [2, 4, 8, 5, 1, 10, 3, 5, 9]],[10, 4, 8, 4, 8, 8, 3, 4, 5], false, GRU65604), 
LRes75107 = reshape_layer(GRU65604, [3, 1], Res75107), 
LRes50937 = reshape_layer(Res75107, [3, 1, 1], Res50937), 
LRes20581 = reshape_layer(Res50937, [3, 1, 1, 1], Res20581), 
LCon87419 = conv3D_layer(Res20581, 1, 1, 1,[[[[[0.6036, 0.6969, 0.8339]]]]],[0, 0, 0], 6, 1, 1, false, 1, 1, 1, Con87419), 
exec_layers([LSub93021,LRes82837,LGRU65604,LRes75107,LRes50937,LRes20581,LCon87419],["Sub93021","Res82837","GRU65604","Res75107","Res50937","Res20581","Con87419"],Con87419,"Con87419")

Actual (Unparsed): [[[[[-0.0000361, -0.0000416, -0.0000498]]]]]

Expected (Unparsed): [[[[[-3.6072024793204656e-5,-4.164777017624971e-5,-4.983509190698039e-5]]]]]

Actual:   [[[[[-0, -0, -0]]]]]

Expected: [[[[[-0, -0, -0]]]]]