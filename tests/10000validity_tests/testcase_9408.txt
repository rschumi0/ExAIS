import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0Mul90742 = tf.keras.layers.Input(shape=([2, 2]))
in1Mul90742 = tf.keras.layers.Input(shape=([2, 2]))

Mul90742 = keras.layers.Multiply(name = 'Mul90742', )([in0Mul90742,in1Mul90742])
GRU7466 = keras.layers.GRU(3,reset_after=True, recurrent_activation='sigmoid', name = 'GRU7466', )(Mul90742)
Res45359 = keras.layers.Reshape((3, 1), name = 'Res45359', )(GRU7466)
Res5137 = keras.layers.Reshape((3, 1, 1), name = 'Res5137', )(Res45359)
Res24170 = keras.layers.Reshape((3, 1, 1, 1), name = 'Res24170', )(Res5137)
Con1115 = keras.layers.Conv3D(3, (2, 1, 1),strides=(1, 1, 1), padding='same', dilation_rate=(1, 1, 1), name = 'Con1115', )(Res24170)
Res7543 = keras.layers.Reshape((3, 1, 3), name = 'Res7543', )(Con1115)
Max330 = keras.layers.MaxPool2D(pool_size=(1, 1), strides=(1, 1), padding='same', name = 'Max330', )(Res7543)
model = tf.keras.models.Model(inputs=[in0Mul90742,in1Mul90742], outputs=Max330)
w = model.get_layer('GRU7466').get_weights() 
w[0] = np.array([[7, 3, 1, 10, 9, 4, 7, 4, 7], [6, 6, 7, 1, 5, 9, 6, 2, 3]])
w[1] = np.array([[4, 3, 10, 4, 2, 1, 2, 2, 8], [1, 1, 5, 7, 2, 2, 10, 4, 8], [3, 2, 1, 3, 4, 4, 2, 4, 3]])
w[2] = np.array([[9, 8, 1, 1, 5, 10, 4, 4, 5], [5, 7, 8, 8, 1, 8, 6, 4, 6]])
model.get_layer('GRU7466').set_weights(w) 
w = model.get_layer('Con1115').get_weights() 
w[0] = np.array([[[[[0.7524, 0.8748, 0.1339]]]], [[[[0.1627, 0.8251, 0.8389]]]]])
w[1] = np.array([0, 0, 0])
model.get_layer('Con1115').set_weights(w) 
in0Mul90742 = tf.constant([[[0.8881, 0.3148], [0.5231, 0.2418]]])
in1Mul90742 = tf.constant([[[0.0771, 0.3729], [0.9683, 0.3415]]])
print (np.array2string(model.predict([in0Mul90742,in1Mul90742],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Max330.png')

LMul90742 = multiply_layer([[[[0.8881, 0.3148], [0.5231, 0.2418]]], [[[0.0771, 0.3729], [0.9683, 0.3415]]]], Mul90742), 
LGRU7466 = gru_layer(Mul90742,[[7, 3, 1, 10, 9, 4, 7, 4, 7], [6, 6, 7, 1, 5, 9, 6, 2, 3]],[[4, 3, 10, 4, 2, 1, 2, 2, 8], [1, 1, 5, 7, 2, 2, 10, 4, 8], [3, 2, 1, 3, 4, 4, 2, 4, 3]],[[9, 8, 1, 1, 5, 10, 4, 4, 5], [5, 7, 8, 8, 1, 8, 6, 4, 6]], true, GRU7466), 
LRes45359 = reshape_layer(GRU7466, [3, 1], Res45359), 
LRes5137 = reshape_layer(Res45359, [3, 1, 1], Res5137), 
LRes24170 = reshape_layer(Res5137, [3, 1, 1, 1], Res24170), 
LCon1115 = conv3D_layer(Res24170, 2, 1, 1,[[[[[0.7524, 0.8748, 0.1339]]]], [[[[0.1627, 0.8251, 0.8389]]]]],[0, 0, 0], 1, 1, 1, true, 1, 1, 1, Con1115), 
LRes7543 = reshape_layer(Con1115, [3, 1, 3], Res7543), 
LMax330 = max_pool2D_layer(Res7543, 1, 1, 1, 1, true, Max330), 
exec_layers([LMul90742,LGRU7466,LRes45359,LRes5137,LRes24170,LCon1115,LRes7543,LMax330],["Mul90742","GRU7466","Res45359","Res5137","Res24170","Con1115","Res7543","Max330"],Max330,"Max330")

Actual (Unparsed): [[[[0.0000002, 0.0000004, 0.0000002]], [[0.0000152, 0.0000764, 0.0000775]], [[0.0000695, 0.0000808, 0.0000124]]]]

Expected (Unparsed): [[[[2.2921746769690693e-7,3.707627349152003e-7,1.7357688972505593e-7]],[[1.5153568849243774e-5,7.6366116880775e-5,7.751949523494827e-5]],[[6.95066773192144e-5,8.081398367736412e-5,1.2369675828073908e-5]]]]

Actual:   [[[[0, 0, 0]], [[0.0001, 0.0001, 0.0001]], [[0.0001, 0.0001, 0.0001]]]]

Expected: [[[[0, 0, 0]], [[0.0001, 0.0001, 0.0001]], [[0.0001, 0.0001, 0.0001]]]]