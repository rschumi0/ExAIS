import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0Glo3029 = tf.keras.layers.Input(shape=([2, 1, 2, 2]))
in0Min2341 = tf.keras.layers.Input(shape=([1, 1]))
in1Min2341 = tf.keras.layers.Input(shape=([1, 1]))
in0Con17128 = tf.keras.layers.Input(shape=([2, 3]))
in0Loc90524 = tf.keras.layers.Input(shape=([2, 2, 1]))

Glo3029 = keras.layers.GlobalMaxPool3D(name = 'Glo3029', )(in0Glo3029)
Res20663 = keras.layers.Reshape((2, 1), name = 'Res20663', )(Glo3029)
Min2341 = keras.layers.Minimum(name = 'Min2341', )([in0Min2341,in1Min2341])
Zer56404 = keras.layers.ZeroPadding1D(padding=((1, 0)), name = 'Zer56404', )(Min2341)
Mul27163 = keras.layers.Multiply(name = 'Mul27163', )([Res20663,Zer56404])
Con17128 = keras.layers.Concatenate(axis=2, name = 'Con17128', )([Mul27163,in0Con17128])
Loc90524 = keras.layers.LocallyConnected2D(3, (1, 2),strides=(8, 1), name = 'Loc90524', )(in0Loc90524)
Res314 = keras.layers.Reshape((1, 3), name = 'Res314', )(Loc90524)
Loc4195 = keras.layers.LocallyConnected1D(4, (1),strides=(1), name = 'Loc4195', )(Res314)
Zer67253 = keras.layers.ZeroPadding1D(padding=((1, 0)), name = 'Zer67253', )(Loc4195)
Min74773 = keras.layers.Minimum(name = 'Min74773', )([Con17128,Zer67253])
Fla36090 = keras.layers.Flatten(name = 'Fla36090', )(Min74773)
Res52418 = keras.layers.Reshape((8, 1), name = 'Res52418', )(Fla36090)
Res81146 = keras.layers.Reshape((8, 1, 1), name = 'Res81146', )(Res52418)
Loc33486 = keras.layers.LocallyConnected2D(4, (4, 1),strides=(1, 1), name = 'Loc33486', )(Res81146)
model = tf.keras.models.Model(inputs=[in0Glo3029,in0Min2341,in1Min2341,in0Con17128,in0Loc90524], outputs=Loc33486)
w = model.get_layer('Loc90524').get_weights() 
w[0] = np.array([[[0.7668, 0.1223, 0.1021], [0.1995, 0.9272, 0.8031]]])
w[1] = np.array([[[0, 0, 0]]])
model.get_layer('Loc90524').set_weights(w) 
w = model.get_layer('Loc4195').get_weights() 
w[0] = np.array([[[0.1057, 0.4059, 0.0628, 0.5243], [0.7756, 0.319, 0.8883, 0.2094], [0.9668, 0.2736, 0.044, 0.5072]]])
w[1] = np.array([[0, 0, 0, 0]])
model.get_layer('Loc4195').set_weights(w) 
w = model.get_layer('Loc33486').get_weights() 
w[0] = np.array([[[0.9238, 0.5219, 0.7501, 0.2848], [0.7657, 0.7288, 0.635, 0.9392], [0.4968, 0.4402, 0.833, 0.8495], [0.5065, 0.1302, 0.9664, 0.5838]], [[0.4526, 0.3837, 0.1928, 0.9269], [0.3381, 0.0736, 0.0252, 0.5802], [0.0096, 0.7467, 0.8746, 0.6454], [0.6864, 0.8385, 0.0083, 0.427]], [[0.4939, 0.6743, 0.4938, 0.5643], [0.6125, 0.0815, 0.3551, 0.0158], [0.5797, 0.8381, 0.6063, 0.9547], [0.4834, 0.1122, 0.0485, 0.2115]], [[0.2741, 0.5101, 0.7148, 0.494], [0.1856, 0.3434, 0.6323, 0.2575], [0.306, 0.2497, 0.1335, 0.7563], [0.6669, 0.3573, 0.2915, 0.5075]], [[0.8298, 0.7717, 0.184, 0.1252], [0.8418, 0.2788, 0.594, 0.2396], [0.6031, 0.8103, 0.4452, 0.01], [0.145, 0.397, 0.7417, 0.5562]]])
w[1] = np.array([[[0, 0, 0, 0]], [[0, 0, 0, 0]], [[0, 0, 0, 0]], [[0, 0, 0, 0]], [[0, 0, 0, 0]]])
model.get_layer('Loc33486').set_weights(w) 
in0Glo3029 = tf.constant([[[[[1.4095, 1.841], [1.9273, 1.6619]]], [[[1.0906, 1.0532], [1.0571, 1.1241]]]]])
in0Min2341 = tf.constant([[[0.8125]]])
in1Min2341 = tf.constant([[[0.761]]])
in0Con17128 = tf.constant([[[0.3923, 0.2728, 0.6016], [0.4031, 0.7666, 0.4101]]])
in0Loc90524 = tf.constant([[[[0.566], [0.429]], [[0.7119], [0.7817]]]])
print (np.array2string(model.predict([in0Glo3029,in0Min2341,in1Min2341,in0Con17128,in0Loc90524],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Loc33486.png')

LGlo3029 = global_max_pool3D_layer([[[[[1.4095, 1.841], [1.9273, 1.6619]]], [[[1.0906, 1.0532], [1.0571, 1.1241]]]]], Glo3029), 
LRes20663 = reshape_layer(Glo3029, [2, 1], Res20663), 
LMin2341 = minimum_layer([[[[0.8125]]], [[[0.761]]]], Min2341), 
LZer56404 = zero_padding1D_layer(Min2341, 1, 0, Zer56404), 
LMul27163 = multiply_layer([Res20663,Zer56404], Mul27163), 
LCon17128 = concatenate_layer([Mul27163,[[[0.3923, 0.2728, 0.6016], [0.4031, 0.7666, 0.4101]]]], 2, Con17128), 
LLoc90524 = locally_connected2D_layer([[[[0.566], [0.429]], [[0.7119], [0.7817]]]], 1, 2,[[[0.7668, 0.1223, 0.1021], [0.1995, 0.9272, 0.8031]]],[[[0, 0, 0]]], 8, 1, Loc90524), 
LRes314 = reshape_layer(Loc90524, [1, 3], Res314), 
LLoc4195 = locally_connected1D_layer(Res314, 1,[[[0.1057, 0.4059, 0.0628, 0.5243], [0.7756, 0.319, 0.8883, 0.2094], [0.9668, 0.2736, 0.044, 0.5072]]],[[0, 0, 0, 0]], 1, Loc4195), 
LZer67253 = zero_padding1D_layer(Loc4195, 1, 0, Zer67253), 
LMin74773 = minimum_layer([Con17128,Zer67253], Min74773), 
LFla36090 = flatten_layer(Min74773, Fla36090), 
LRes52418 = reshape_layer(Fla36090, [8, 1], Res52418), 
LRes81146 = reshape_layer(Res52418, [8, 1, 1], Res81146), 
LLoc33486 = locally_connected2D_layer(Res81146, 4, 1,[[[0.9238, 0.5219, 0.7501, 0.2848], [0.7657, 0.7288, 0.635, 0.9392], [0.4968, 0.4402, 0.833, 0.8495], [0.5065, 0.1302, 0.9664, 0.5838]], [[0.4526, 0.3837, 0.1928, 0.9269], [0.3381, 0.0736, 0.0252, 0.5802], [0.0096, 0.7467, 0.8746, 0.6454], [0.6864, 0.8385, 0.0083, 0.427]], [[0.4939, 0.6743, 0.4938, 0.5643], [0.6125, 0.0815, 0.3551, 0.0158], [0.5797, 0.8381, 0.6063, 0.9547], [0.4834, 0.1122, 0.0485, 0.2115]], [[0.2741, 0.5101, 0.7148, 0.494], [0.1856, 0.3434, 0.6323, 0.2575], [0.306, 0.2497, 0.1335, 0.7563], [0.6669, 0.3573, 0.2915, 0.5075]], [[0.8298, 0.7717, 0.184, 0.1252], [0.8418, 0.2788, 0.594, 0.2396], [0.6031, 0.8103, 0.4452, 0.01], [0.145, 0.397, 0.7417, 0.5562]]],[[[0, 0, 0, 0]], [[0, 0, 0, 0]], [[0, 0, 0, 0]], [[0, 0, 0, 0]], [[0, 0, 0, 0]]], 1, 1, Loc33486), 
exec_layers([LGlo3029,LRes20663,LMin2341,LZer56404,LMul27163,LCon17128,LLoc90524,LRes314,LLoc4195,LZer67253,LMin74773,LFla36090,LRes52418,LRes81146,LLoc33486],["Glo3029","Res20663","Min2341","Zer56404","Mul27163","Con17128","Loc90524","Res314","Loc4195","Zer67253","Min74773","Fla36090","Res52418","Res81146","Loc33486"],Loc33486,"Loc33486")

Actual (Unparsed): [[[[0.0000000, 0.0000000, 0.0000000, 0.0000000]], [[0.5532937, 0.6758985, 0.0066905, 0.3441964]], [[0.6621434, 0.7208039, 0.5082770, 0.8548207]], [[0.5831725, 0.5436639, 0.6990928, 0.7484991]], [[1.3482179, 1.2741657, 0.8990208, 0.4302533]]]]

Expected (Unparsed): [[[[0.0,0.0,0.0,0.0]],[[0.553293691352688,0.6758985434137951,0.006690468587161,0.34419639599009]],[[0.662143436382799,0.720803931192727,0.508276989083821,0.854820753634049]],[[0.58317254532229,0.543663901981824,0.699092806828071,0.748499117467675]],[[1.348217891104228,1.274165722257445,0.899020751027384,0.43025326805448405]]]]

Actual:   [[[[0, 0, 0, 0]], [[0.5533, 0.6759, 0.0067, 0.3442]], [[0.6622, 0.7209, 0.5083, 0.8549]], [[0.5832, 0.5437, 0.6991, 0.7485]], [[1.3483, 1.2742, 0.8991, 0.4303]]]]

Expected: [[[[0, 0, 0, 0]], [[0.5533, 0.6759, 0.0067, 0.3442]], [[0.6622, 0.7209, 0.5083, 0.8549]], [[0.5832, 0.5437, 0.6991, 0.7485]], [[1.3483, 1.2742, 0.8991, 0.4303]]]]