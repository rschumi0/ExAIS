import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0Con293 = tf.keras.layers.Input(shape=([1, 1, 2, 1]))
in0Con43749 = tf.keras.layers.Input(shape=([20]))
in0Up_37635 = tf.keras.layers.Input(shape=([4, 3, 1]))

Con293 = keras.layers.Conv3D(4, (1, 1, 1),strides=(1, 11, 7), padding='same', dilation_rate=(1, 1, 1), name = 'Con293', )(in0Con293)
Res17870 = keras.layers.Reshape((1, 1, 4), name = 'Res17870', )(Con293)
Res18532 = keras.layers.Reshape((1, 4), name = 'Res18532', )(Res17870)
Fla85334 = keras.layers.Flatten(name = 'Fla85334', )(Res18532)
Con43749 = keras.layers.Concatenate(axis=1, name = 'Con43749', )([Fla85334,in0Con43749])
Up_37635 = keras.layers.UpSampling2D(size=(1, 2), name = 'Up_37635', )(in0Up_37635)
Fla96368 = keras.layers.Flatten(name = 'Fla96368', )(Up_37635)
Ave4422 = keras.layers.Average(name = 'Ave4422', )([Con43749,Fla96368])
model = tf.keras.models.Model(inputs=[in0Con293,in0Con43749,in0Up_37635], outputs=Ave4422)
w = model.get_layer('Con293').get_weights() 
w[0] = np.array([[[[[0.0008, 0.2175, 0.4963, 0.4077]]]]])
w[1] = np.array([0, 0, 0, 0])
model.get_layer('Con293').set_weights(w) 
in0Con293 = tf.constant([[[[[0.5841], [0.4881]]]]])
in0Con43749 = tf.constant([[0.8654, 0.6873, 0.797, 0.6444, 0.9872, 0.0182, 0.7949, 0.0035, 0.4228, 0.9406, 0.5384, 0.7969, 0.7664, 0.911, 0.8369, 0.3629, 0.2679, 0.8459, 0.891, 0.0211]])
in0Up_37635 = tf.constant([[[[1.2698], [1.6828], [1.0613]], [[1.5462], [1.9531], [1.6164]], [[1.0768], [1.4045], [1.5566]], [[1.9564], [1.9532], [1.1831]]]])
print (np.array2string(model.predict([in0Con293,in0Con43749,in0Up_37635],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Ave4422.png')

LCon293 = conv3D_layer([[[[[0.5841], [0.4881]]]]], 1, 1, 1,[[[[[0.0008, 0.2175, 0.4963, 0.4077]]]]],[0, 0, 0, 0], 1, 11, 7, true, 1, 1, 1, Con293), 
LRes17870 = reshape_layer(Con293, [1, 1, 4], Res17870), 
LRes18532 = reshape_layer(Res17870, [1, 4], Res18532), 
LFla85334 = flatten_layer(Res18532, Fla85334), 
LCon43749 = concatenate_layer([Fla85334,[[0.8654, 0.6873, 0.797, 0.6444, 0.9872, 0.0182, 0.7949, 0.0035, 0.4228, 0.9406, 0.5384, 0.7969, 0.7664, 0.911, 0.8369, 0.3629, 0.2679, 0.8459, 0.891, 0.0211]]], 1, Con43749), 
LUp_37635 = up_sampling2D_layer([[[[1.2698], [1.6828], [1.0613]], [[1.5462], [1.9531], [1.6164]], [[1.0768], [1.4045], [1.5566]], [[1.9564], [1.9532], [1.1831]]]], 1, 2, Up_37635), 
LFla96368 = flatten_layer(Up_37635, Fla96368), 
LAve4422 = average_layer([Con43749,Fla96368], Ave4422), 
exec_layers([LCon293,LRes17870,LRes18532,LFla85334,LCon43749,LUp_37635,LFla96368,LAve4422],["Con293","Res17870","Res18532","Fla85334","Con43749","Up_37635","Fla96368","Ave4422"],Ave4422,"Ave4422")

Actual (Unparsed): [[0.6351336, 0.6984208, 0.9863444, 0.9604688, 0.9633500, 0.8743000, 1.1716000, 1.0953000, 1.4701500, 0.9856500, 1.2056500, 0.8099500, 0.7498000, 1.0087000, 0.9714500, 1.1007000, 1.1615000, 1.2338000, 1.3966500, 1.1596500, 1.1105500, 1.3995500, 1.0370500, 0.6021000]]

Expected (Unparsed): [[0.63513364,0.698420875,0.986344415,0.960468785,0.9633499999999999,0.8743,1.1716,1.0953,1.47015,0.98565,1.20565,0.8099500000000001,0.7498,1.0087,0.97145,1.1007,1.1615,1.2338,1.39665,1.15965,1.11055,1.39955,1.03705,0.6021]]

Actual:   [[0.6352, 0.6985, 0.9864, 0.9605, 0.9634, 0.8743, 1.1716, 1.0953, 1.4702, 0.9857, 1.2057, 0.81, 0.7498, 1.0087, 0.9715, 1.1007, 1.1615, 1.2338, 1.3967, 1.1597, 1.1106, 1.3996, 1.0371, 0.6021]]

Expected: [[0.6352, 0.6985, 0.9864, 0.9605, 0.9634, 0.8743, 1.1716, 1.0953, 1.4702, 0.9857, 1.2057, 0.81, 0.7498, 1.0087, 0.9715, 1.1007, 1.1615, 1.2338, 1.3967, 1.1597, 1.1106, 1.3996, 1.0371, 0.6021]]