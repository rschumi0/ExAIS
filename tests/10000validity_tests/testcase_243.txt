import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0Mul91353 = tf.keras.layers.Input(shape=([2, 2, 1]))
in1Mul91353 = tf.keras.layers.Input(shape=([2, 2, 1]))
in0Glo66502 = tf.keras.layers.Input(shape=([1, 1, 2]))
in0Con55271 = tf.keras.layers.Input(shape=([2]))

Mul91353 = keras.layers.Multiply(name = 'Mul91353', )([in0Mul91353,in1Mul91353])
Res86176 = keras.layers.Reshape((2, 2), name = 'Res86176', )(Mul91353)
Fla70914 = keras.layers.Flatten(name = 'Fla70914', )(Res86176)
Glo66502 = keras.layers.GlobalMaxPool2D(name = 'Glo66502', )(in0Glo66502)
Res45329 = keras.layers.Reshape((2, 1), name = 'Res45329', )(Glo66502)
Res61378 = keras.layers.Reshape((2, 1, 1), name = 'Res61378', )(Res45329)
Ave50749 = keras.layers.AveragePooling2D(pool_size=(2, 1), name = 'Ave50749', )(Res61378)
Res97627 = keras.layers.Reshape((1, 1), name = 'Res97627', )(Ave50749)
Loc36565 = keras.layers.LocallyConnected1D(4, (1),strides=(1), name = 'Loc36565', )(Res97627)
LST6755 = keras.layers.LSTM(2,recurrent_activation='sigmoid', name = 'LST6755', )(Loc36565)
Con55271 = keras.layers.Concatenate(axis=1, name = 'Con55271', )([LST6755,in0Con55271])
Add65642 = keras.layers.Add(name = 'Add65642', )([Fla70914,Con55271])
model = tf.keras.models.Model(inputs=[in0Mul91353,in1Mul91353,in0Glo66502,in0Con55271], outputs=Add65642)
w = model.get_layer('Loc36565').get_weights() 
w[0] = np.array([[[0.5486, 0.3511, 0.2489, 0.6322]]])
w[1] = np.array([[0, 0, 0, 0]])
model.get_layer('Loc36565').set_weights(w) 
w = model.get_layer('LST6755').get_weights() 
w[0] = np.array([[6, 7, 9, 6, 4, 9, 3, 1], [10, 9, 4, 10, 8, 5, 5, 5], [3, 1, 8, 8, 5, 6, 2, 8], [9, 9, 1, 2, 8, 10, 2, 1]])
w[1] = np.array([[9, 10, 1, 10, 5, 1, 2, 7], [3, 6, 7, 4, 5, 6, 2, 3]])
w[2] = np.array([3, 9, 6, 4, 9, 3, 3, 8])
model.get_layer('LST6755').set_weights(w) 
in0Mul91353 = tf.constant([[[[0.9331], [0.7715]], [[0.6796], [0.413]]]])
in1Mul91353 = tf.constant([[[[0.8875], [0.2898]], [[0.2111], [0.9329]]]])
in0Glo66502 = tf.constant([[[[1.5072, 1.7475]]]])
in0Con55271 = tf.constant([[0.2794, 0.5969]])
print (np.array2string(model.predict([in0Mul91353,in1Mul91353,in0Glo66502,in0Con55271],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Add65642.png')

LMul91353 = multiply_layer([[[[[0.9331], [0.7715]], [[0.6796], [0.413]]]], [[[[0.8875], [0.2898]], [[0.2111], [0.9329]]]]], Mul91353), 
LRes86176 = reshape_layer(Mul91353, [2, 2], Res86176), 
LFla70914 = flatten_layer(Res86176, Fla70914), 
LGlo66502 = global_max_pool2D_layer([[[[1.5072, 1.7475]]]], Glo66502), 
LRes45329 = reshape_layer(Glo66502, [2, 1], Res45329), 
LRes61378 = reshape_layer(Res45329, [2, 1, 1], Res61378), 
LAve50749 = average_pooling2D_layer(Res61378, 2, 1, Ave50749), 
LRes97627 = reshape_layer(Ave50749, [1, 1], Res97627), 
LLoc36565 = locally_connected1D_layer(Res97627, 1,[[[0.5486, 0.3511, 0.2489, 0.6322]]],[[0, 0, 0, 0]], 1, Loc36565), 
LLST6755 = lstm_layer(Loc36565,[[6, 7, 9, 6, 4, 9, 3, 1], [10, 9, 4, 10, 8, 5, 5, 5], [3, 1, 8, 8, 5, 6, 2, 8], [9, 9, 1, 2, 8, 10, 2, 1]],[[9, 10, 1, 10, 5, 1, 2, 7], [3, 6, 7, 4, 5, 6, 2, 3]],[3, 9, 6, 4, 9, 3, 3, 8], LST6755), 
LCon55271 = concatenate_layer([LST6755,[[0.2794, 0.5969]]], 1, Con55271), 
LAdd65642 = add_layer([Fla70914,Con55271], Add65642), 
exec_layers([LMul91353,LRes86176,LFla70914,LGlo66502,LRes45329,LRes61378,LAve50749,LRes97627,LLoc36565,LLST6755,LCon55271,LAdd65642],["Mul91353","Res86176","Fla70914","Glo66502","Res45329","Res61378","Ave50749","Res97627","Loc36565","LST6755","Con55271","Add65642"],Add65642,"Add65642")

Actual (Unparsed): [[1.5897119, 0.9851748, 0.4228635, 0.9821877]]

Expected (Unparsed): [[1.589711903650947,0.9851747718430645,0.42286355999999997,0.9821876999999999]]

Actual:   [[1.5898, 0.9852, 0.4229, 0.9822]]

Expected: [[1.5898, 0.9852, 0.4229, 0.9822]]