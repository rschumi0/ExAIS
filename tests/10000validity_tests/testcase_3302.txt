import tensorflow as tf
from tensorflow import keras
from tensorflow.keras import layers
import numpy as np
np.set_printoptions(suppress=True,threshold=np.inf,formatter={'float_kind':'{:16.7f}'.format})
tf.keras.backend.set_floatx('float64')
in0LST98709 = tf.keras.layers.Input(shape=([2, 1]))
in0Sub70188 = tf.keras.layers.Input(shape=([3, 2]))
in1Sub70188 = tf.keras.layers.Input(shape=([3, 2]))

LST98709 = keras.layers.LSTM(2,recurrent_activation='sigmoid', name = 'LST98709', )(in0LST98709)
Res34578 = keras.layers.Reshape((2, 1), name = 'Res34578', )(LST98709)
Res71324 = keras.layers.Reshape((2, 1, 1), name = 'Res71324', )(Res34578)
Con49190 = keras.layers.Conv2DTranspose(2, (2, 1),strides=(1, 1), padding='valid', name = 'Con49190', )(Res71324)
Res53171 = keras.layers.Reshape((3, 2), name = 'Res53171', )(Con49190)
Sub70188 = keras.layers.Subtract(name = 'Sub70188', )([in0Sub70188,in1Sub70188])
Ave65575 = keras.layers.Average(name = 'Ave65575', )([Res53171,Sub70188])
Res87961 = keras.layers.Reshape((3, 2, 1), name = 'Res87961', )(Ave65575)
Con20853 = keras.layers.Conv2DTranspose(4, (1, 1),strides=(1, 1), padding='valid', name = 'Con20853', )(Res87961)
model = tf.keras.models.Model(inputs=[in0LST98709,in0Sub70188,in1Sub70188], outputs=Con20853)
w = model.get_layer('LST98709').get_weights() 
w[0] = np.array([[1, 3, 3, 2, 7, 5, 4, 6]])
w[1] = np.array([[4, 2, 6, 1, 2, 3, 2, 5], [8, 10, 5, 1, 4, 6, 9, 5]])
w[2] = np.array([8, 2, 6, 1, 7, 2, 5, 10])
model.get_layer('LST98709').set_weights(w) 
w = model.get_layer('Con49190').get_weights() 
w[0] = np.array([[[[0.0708], [0.3885]]], [[[0.8278], [0.7087]]]])
w[1] = np.array([0, 0])
model.get_layer('Con49190').set_weights(w) 
w = model.get_layer('Con20853').get_weights() 
w[0] = np.array([[[[0.5424], [0.8673], [0.9504], [0.1472]]]])
w[1] = np.array([0, 0, 0, 0])
model.get_layer('Con20853').set_weights(w) 
in0LST98709 = tf.constant([[[1], [4]]])
in0Sub70188 = tf.constant([[[0.7684, 0.6923], [0.3356, 0.5416], [0.3713, 0.8952]]])
in1Sub70188 = tf.constant([[[0.4722, 0.0364], [0.7803, 0.1066], [0.7956, 0.0827]]])
print (np.array2string(model.predict([in0LST98709,in0Sub70188,in1Sub70188],steps=1), separator=', '))
from tensorflow.keras.utils import plot_model
plot_model(model, to_file='Con20853.png')

LLST98709 = lstm_layer([[[1], [4]]],[[1, 3, 3, 2, 7, 5, 4, 6]],[[4, 2, 6, 1, 2, 3, 2, 5], [8, 10, 5, 1, 4, 6, 9, 5]],[8, 2, 6, 1, 7, 2, 5, 10], LST98709), 
LRes34578 = reshape_layer(LST98709, [2, 1], Res34578), 
LRes71324 = reshape_layer(Res34578, [2, 1, 1], Res71324), 
LCon49190 = conv2D_transpose_layer(Res71324, 2, 1,[[[[0.0708], [0.3885]]], [[[0.8278], [0.7087]]]],[0, 0], 1, 1, false, Con49190), 
LRes53171 = reshape_layer(Con49190, [3, 2], Res53171), 
LSub70188 = subtract_layer([[[0.7684, 0.6923], [0.3356, 0.5416], [0.3713, 0.8952]]], [[[0.4722, 0.0364], [0.7803, 0.1066], [0.7956, 0.0827]]], Sub70188), 
LAve65575 = average_layer([Res53171,Sub70188], Ave65575), 
LRes87961 = reshape_layer(Ave65575, [3, 2, 1], Res87961), 
LCon20853 = conv2D_transpose_layer(Res87961, 1, 1,[[[[0.5424], [0.8673], [0.9504], [0.1472]]]],[0, 0, 0, 0], 1, 1, false, Con20853), 
exec_layers([LLST98709,LRes34578,LRes71324,LCon49190,LRes53171,LSub70188,LAve65575,LRes87961,LCon20853],["LST98709","Res34578","Res71324","Con49190","Res53171","Sub70188","Ave65575","Res87961","Con20853"],Con20853,"Con20853")

Actual (Unparsed): [[[[0.0988395, 0.1580448, 0.1731878, 0.0268237], [0.2794503, 0.4468422, 0.4896562, 0.0758390]], [[0.1143200, 0.1827983, 0.2003130, 0.0310249], [0.4047766, 0.6472396, 0.7092546, 0.1098509]], [[0.1012461, 0.1618930, 0.1774047, 0.0274768], [0.4055437, 0.6484662, 0.7105987, 0.1100591]]]]

Expected (Unparsed): [[[[0.0988395275904946,0.1580448419602433,0.17318784480458346,0.026823706602730098],[0.2794502640241124,0.4468422086801487,0.4896562148387102,0.07583900970565881]],[[0.1143200551337898,0.18279827399988183,0.20031301696009188,0.031024911717724667],[0.404776629939275,0.6472396223199358,0.7092546259112961,0.10985088482127817]],[[0.10124611402183294,0.16189298431256582,0.1774046953656896,0.027476821504450237],[0.4055436982354107,0.6484661679195644,0.710598692483286,0.11005905674825305]]]]

Actual:   [[[[0.0989, 0.1581, 0.1732, 0.0269], [0.2795, 0.4469, 0.4897, 0.0759]], [[0.1144, 0.1828, 0.2004, 0.0311], [0.4048, 0.6473, 0.7093, 0.1099]], [[0.1013, 0.1619, 0.1775, 0.0275], [0.4056, 0.6485, 0.7106, 0.1101]]]]

Expected: [[[[0.0989, 0.1581, 0.1732, 0.0269], [0.2795, 0.4469, 0.4897, 0.0759]], [[0.1144, 0.1828, 0.2004, 0.0311], [0.4048, 0.6473, 0.7093, 0.1099]], [[0.1013, 0.1619, 0.1775, 0.0275], [0.4056, 0.6485, 0.7106, 0.1101]]]]